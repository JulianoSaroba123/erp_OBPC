{% extends "base.html" %}

{% block title %}Lançamentos - OBPC{% endblock %}

{% block content %}

<!-- CSS Customizado para a tabela -->
<style>
.table-responsive {
    overflow-x: auto !important;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    max-height: 70vh;
    overflow-y: auto;
    width: 100%;
}

.table-financial {
    min-width: 1200px;
    margin-bottom: 0;
    white-space: nowrap;
    width: 100%;
}

.table-financial th,
.table-financial td {
    white-space: nowrap;
    padding: 8px 12px;
}

/* Colunas específicas com larguras */
.table-financial .col-data { min-width: 100px; }
.table-financial .col-tipo { min-width: 90px; }
.table-financial .col-categoria { min-width: 120px; }
.table-financial .col-descricao { min-width: 200px; }
.table-financial .col-valor { min-width: 110px; }
.table-financial .col-conta { min-width: 100px; }
.table-financial .col-observacoes { min-width: 150px; }
.table-financial .col-comprovante { min-width: 100px; }
.table-financial .col-acoes { min-width: 80px; }

/* Scrollbar customizada */
.table-responsive::-webkit-scrollbar {
    height: 12px;
    width: 12px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 6px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #228b22;
    border-radius: 6px;
    border: 2px solid #f1f1f1;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #006400;
}

/* Indicador de scroll */
.scroll-hint {
    font-size: 11px;
    color: #666;
    text-align: center;
    padding: 5px;
    background: #f8f9fa;
    border-top: 1px solid #dee2e6;
}

/* Ajustes para maximizar o uso do espaço */
.main-container {
    width: 100%;
    max-width: none;
    padding: 0 15px;
}

.financial-card {
    width: 100%;
    max-width: 100%;
    margin: 0;
}
</style>

<div class="main-container">
    <div class="row">
        <div class="col-12">
            {% if importacao_recente %}
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Importação Concluída!</strong> Os lançamentos importados estão destacados e aparecem no topo da lista.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}
            
            <div class="row align-items-center mb-4">
                <div class="col-md-6">
                    <h2><i class="fas fa-money-bill-wave text-success me-2"></i>Controle Financeiro</h2>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-end gap-2 flex-wrap">
                        <!-- Dropdown Relatórios -->
                        <div class="dropdown">
                            <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-chart-bar me-1"></i> Relatórios
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="{{ url_for('financeiro.gerar_relatorio') }}">
                                    <i class="fas fa-list me-1"></i> Relatório Geral
                                </a></li>
                                <li><a class="dropdown-item" href="{{ url_for('financeiro.relatorio_caixa') }}">
                                    <i class="fas fa-cash-register me-1"></i> Relatório de Caixa
                                </a></li>
                                <li><a class="dropdown-item" href="{{ url_for('financeiro.relatorio_sede') }}">
                                    <i class="fas fa-file-alt me-1"></i> Relatório para Sede
                                </a></li>
                            </ul>
                        </div>
                        
                      
                        
                        <!-- Botões Ações -->
                        <a href="{{ url_for('financeiro.novo_lancamento') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i> Novo
                        </a>
                        <a href="{{ url_for('financeiro.importar_extrato') }}" class="btn btn-outline-secondary ms-2">
                            <i class="fas fa-file-import me-1"></i> Importar
                        </a>
                        <a href="{{ url_for('financeiro.conciliacao') }}" class="btn btn-outline-success ms-2">
                            <i class="fas fa-balance-scale me-1"></i> Conciliar
                        </a>
                    </div>
                </div>
            </div>

            <!-- Indicadores de Conciliação -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-history fa-2x mb-2"></i>
                            <h5>{{ conciliacao_info.total_conciliados if conciliacao_info else 0 }}</h5>
                            <p class="mb-0">Total Conciliados (últ.)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-warning text-dark">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <h5>{{ conciliacao_info.total_pendentes if conciliacao_info else 0 }}</h5>
                            <p class="mb-0">Pendentes (últ.)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-secondary text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                            <h6 class="mb-0">{% if conciliacao_info and conciliacao_info.ultima_data %}{{ conciliacao_info.ultima_data.strftime('%d/%m/%Y %H:%M') }}{% else %}-{% endif %}</h6>
                            <p class="mb-0">Última Conciliação</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Cards com Totais -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title mb-0">Entradas</h5>
                                    <h3 class="mb-0">R$ {{ "%.2f"|format(totais_filtrados.entradas)|replace(".", ",") }}</h3>
                                    {% if filtros.categoria or filtros.tipo or filtros.conta or filtros.data_inicial or filtros.data_final or filtros.valor_min or filtros.valor_max or filtros.busca_texto %}
                                    <small class="opacity-75">Filtrado: R$ {{ "%.2f"|format(totais_filtrados.entradas)|replace(".", ",") }}</small><br>
                                    <small class="opacity-75">Total Geral: R$ {{ "%.2f"|format(totais_gerais.entradas)|replace(".", ",") }}</small>
                                    {% endif %}
                                </div>
                                <i class="fas fa-arrow-up fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title mb-0">Saídas</h5>
                                    <h3 class="mb-0">R$ {{ "%.2f"|format(totais_filtrados.saidas)|replace(".", ",") }}</h3>
                                    {% if filtros.categoria or filtros.tipo or filtros.conta or filtros.data_inicial or filtros.data_final or filtros.valor_min or filtros.valor_max or filtros.busca_texto %}
                                    <small class="opacity-75">Filtrado: R$ {{ "%.2f"|format(totais_filtrados.saidas)|replace(".", ",") }}</small><br>
                                    <small class="opacity-75">Total Geral: R$ {{ "%.2f"|format(totais_gerais.saidas)|replace(".", ",") }}</small>
                                    {% endif %}
                                </div>
                                <i class="fas fa-arrow-down fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-{% if totais_filtrados.saldo >= 0 %}success{% else %}warning{% endif %} text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title mb-0">Saldo</h5>
                                    <h3 class="mb-0">R$ {{ "%.2f"|format(totais_filtrados.saldo)|replace(".", ",") }}</h3>
                                    {% if filtros.categoria or filtros.tipo or filtros.conta or filtros.data_inicial or filtros.data_final or filtros.valor_min or filtros.valor_max or filtros.busca_texto %}
                                    <small class="opacity-75">Filtrado: R$ {{ "%.2f"|format(totais_filtrados.saldo)|replace(".", ",") }}</small><br>
                                    <small class="opacity-75">Total Geral: R$ {{ "%.2f"|format(totais_gerais.saldo)|replace(".", ",") }}</small>
                                    {% endif %}
                                </div>
                                <i class="fas fa-{% if totais_filtrados.saldo >= 0 %}chart-line{% else %}exclamation-triangle{% endif %} fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title mb-0">Registros</h5>
                                    <h3 class="mb-0">{{ lancamentos|length }}</h3>
                                    {% if filtros.categoria or filtros.tipo or filtros.conta or filtros.data_inicial or filtros.data_final or filtros.valor_min or filtros.valor_max or filtros.busca_texto %}
                                    <small class="opacity-75">Filtrados: {{ lancamentos|length }}</small>
                                    {% endif %}
                                </div>
                                <i class="fas fa-list fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros Avançados -->
            <div class="card financial-card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros Avançados</h5>
                        <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosAvancados" aria-expanded="false">
                            <i class="fas fa-chevron-down me-1"></i> Expandir Filtros
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Formulário de Filtros -->
                    <form method="GET" id="formFiltros">
                        
                        <!-- Filtros Básicos (sempre visíveis) -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                <label for="categoria" class="form-label">Categoria</label>
                                <select class="form-select" id="categoria" name="categoria">
                                    <option value="">Todas as categorias</option>
                                    {% for categoria in categorias_unicas %}
                                    <option value="{{ categoria }}" {% if filtros.categoria == categoria %}selected{% endif %}>
                                        {{ categoria }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="tipo" class="form-label">Tipo</label>
                                <select class="form-select" id="tipo" name="tipo">
                                    <option value="">Todos os tipos</option>
                                    <option value="Entrada" {% if filtros.tipo == 'Entrada' %}selected{% endif %}>
                                        <i class="fas fa-arrow-up text-success"></i> Entrada
                                    </option>
                                    <option value="Saída" {% if filtros.tipo == 'Saída' %}selected{% endif %}>
                                        <i class="fas fa-arrow-down text-danger"></i> Saída
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="conta" class="form-label">Conta</label>
                                <select class="form-select" id="conta" name="conta">
                                    <option value="">Todas as contas</option>
                                    {% for conta in contas_unicas %}
                                    <option value="{{ conta }}" {% if filtros.conta == conta %}selected{% endif %}>
                                        {{ conta }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="busca_texto" class="form-label">Buscar Texto</label>
                                <input type="text" class="form-control" id="busca_texto" name="busca_texto" 
                                       value="{{ filtros.busca_texto }}" placeholder="Descrição ou observações">
                            </div>
                        </div>

                        <!-- Filtros Avançados (colapsáveis) -->
                        <div class="collapse" id="filtrosAvancados">
                            <hr>
                            <div class="row g-3 mb-3">
                                <!-- Filtros de Data -->
                                <div class="col-md-3">
                                    <label for="data_inicial" class="form-label">Data Inicial</label>
                                    <input type="date" class="form-control" id="data_inicial" name="data_inicial" 
                                           value="{{ filtros.data_inicial }}">
                                </div>
                                <div class="col-md-3">
                                    <label for="data_final" class="form-label">Data Final</label>
                                    <input type="date" class="form-control" id="data_final" name="data_final" 
                                           value="{{ filtros.data_final }}">
                                </div>
                                
                                <!-- Filtros de Valor -->
                                <div class="col-md-3">
                                    <label for="valor_min" class="form-label">Valor Mínimo (R$)</label>
                                    <input type="text" class="form-control" id="valor_min" name="valor_min" 
                                           value="{{ filtros.valor_min }}" placeholder="0,00">
                                </div>
                                <div class="col-md-3">
                                    <label for="valor_max" class="form-label">Valor Máximo (R$)</label>
                                    <input type="text" class="form-control" id="valor_max" name="valor_max" 
                                           value="{{ filtros.valor_max }}" placeholder="999999,99">
                                </div>
                            </div>
                        </div>

                        <!-- Botões de Ação -->
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-1"></i> Filtrar
                            </button>
                            {% if filtros.categoria or filtros.tipo or filtros.conta or filtros.data_inicial or filtros.data_final or filtros.valor_min or filtros.valor_max or filtros.busca_texto %}
                            <a href="{{ url_for('financeiro.lista_lancamentos') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i> Limpar Todos
                            </a>
                            {% endif %}
                            
                            <!-- Botões de Ação Rápida -->
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="filtroMesAtual()">
                                    <i class="fas fa-calendar-alt me-1"></i> Mês Atual
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="filtroUltimos30Dias()">
                                    <i class="fas fa-calendar me-1"></i> Últimos 30 dias
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="filtroEntradas()">
                                    <i class="fas fa-arrow-up me-1"></i> Só Entradas
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="filtroSaidas()">
                                    <i class="fas fa-arrow-down me-1"></i> Só Saídas
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Totais por Categoria -->
                    {% if totais_por_categoria %}
                    <div class="row">
                        <div class="col-12">
                            <div class="card financial-card mb-3">
                                <div class="card-header">
                                    <h6 class="text-primary mb-0"><i class="fas fa-chart-pie me-1"></i> Resumo por Categoria{% if filtros.tipo %} ({{ filtros.tipo }}){% endif %}</h6>
                                </div>
                                <div class="card-body p-2">
                                <table class="table table-sm table-striped">
                                    <thead class="table-primary">
                                        <tr>
                                            <th>Categoria</th>
                                            <th class="text-end">Entradas</th>
                                            <th class="text-end">Saídas</th>
                                            <th class="text-end">Saldo</th>
                                            <th class="text-center">Registros</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for categoria, dados in totais_por_categoria.items() %}
                                        <tr>
                                            <td>
                                                <a href="{{ url_for('financeiro.lista_lancamentos', categoria=categoria, tipo=filtros.tipo) }}" 
                                                   class="text-decoration-none">
                                                    {{ categoria }}
                                                </a>
                                            </td>
                                            <td class="text-end text-success fw-bold">
                                                R$ {{ "%.2f"|format(dados.entradas)|replace(".", ",") }}
                                            </td>
                                            <td class="text-end text-danger fw-bold">
                                                R$ {{ "%.2f"|format(dados.saidas)|replace(".", ",") }}
                                            </td>
                                            <td class="text-end fw-bold text-{% if dados.saldo >= 0 %}success{% else %}danger{% endif %}">
                                                R$ {{ "%.2f"|format(dados.saldo)|replace(".", ",") }}
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-info">{{ dados.total_registros }}</span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

            <!-- Tabela de Lançamentos -->
            {% if lancamentos %}
            <div class="card financial-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Lista de Lançamentos
                        {% if filtros.categoria or filtros.tipo or filtros.conta or filtros.data_inicial or filtros.data_final or filtros.valor_min or filtros.valor_max or filtros.busca_texto %}
                        <span class="badge bg-primary ms-2">
                            Filtrado
                            {% if filtros.categoria %}por "{{ filtros.categoria }}"{% endif %}
                            {% if filtros.tipo %}({{ filtros.tipo }}){% endif %}
                            {% if filtros.conta %}[{{ filtros.conta }}]{% endif %}
                            {% if filtros.data_inicial or filtros.data_final %}
                                <i class="fas fa-calendar-alt ms-1"></i>
                            {% endif %}
                            {% if filtros.valor_min or filtros.valor_max %}
                                <i class="fas fa-dollar-sign ms-1"></i>
                            {% endif %}
                            {% if filtros.busca_texto %}
                                <i class="fas fa-search ms-1"></i>
                            {% endif %}
                        </span>
                        {% endif %}
                    </h5>
                    {% if filtros.categoria or filtros.tipo or filtros.conta or filtros.data_inicial or filtros.data_final or filtros.valor_min or filtros.valor_max or filtros.busca_texto %}
                    <small class="text-muted">
                        Mostrando {{ lancamentos|length }} registros filtrados
                    </small>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-financial mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th class="col-data">
                                        <i class="fas fa-calendar me-1"></i>Data
                                    </th>
                                    <th class="col-tipo"><i class="fas fa-exchange-alt me-1"></i>Tipo</th>
                                    <th class="col-categoria"><i class="fas fa-tags me-1"></i>Categoria</th>
                                    <th class="col-descricao">Descrição</th>
                                    <th class="col-valor"><i class="fas fa-dollar-sign me-1"></i>Valor</th>
                                    <th class="col-conta"><i class="fas fa-wallet me-1"></i>Conta</th>
                                    <th class="col-observacoes">Observações</th>
                                    <th class="col-comprovante"><i class="fas fa-paperclip me-1"></i>Comprovante</th>
                                    <th class="col-acoes">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lancamento in lancamentos %}
                                <!-- DEBUG: ID {{ lancamento.id }} - Tipo: {{ lancamento.tipo }} - Origem: {{ lancamento.origem }} -->
                                <tr {% if lancamento.origem == 'importado' %}class="table-info"{% endif %}>
                                    <td>
                                        {{ lancamento.data.strftime('%d/%m/%Y') if lancamento.data else '-' }}
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if lancamento.tipo == 'Entrada' %}success{% else %}danger{% endif %}">
                                            <i class="{{ lancamento.tipo_icon }}"></i> {{ lancamento.tipo }}
                                        </span>
                                    </td>
                                    <td>{{ lancamento.categoria or '-' }}
                                        {% if lancamento.origem == 'importado' %}
                                        <small class="badge bg-info ms-1">
                                            <i class="fas fa-download"></i> Importado
                                        </small>
                                        {% endif %}
                                    </td>
                                    <td>{{ lancamento.descricao or '-' }}</td>
                                    <td class="text-{% if lancamento.tipo == 'Entrada' %}success{% else %}danger{% endif %} fw-bold">
                                        {{ lancamento.valor_formatado }}
                                    </td>
                                    <td>
                                        <i class="{{ lancamento.conta_icon }}"></i> {{ lancamento.conta }}
                                    </td>
                                    <td>
                                        {% if lancamento.observacoes and lancamento.observacoes != 'None' and lancamento.observacoes.strip() %}
                                        <span data-bs-toggle="tooltip" title="{{ lancamento.observacoes }}">
                                            {{ lancamento.observacoes[:30] }}{% if lancamento.observacoes|length > 30 %}...{% endif %}
                                        </span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if lancamento.tem_comprovante() %}
                                        <a href="{{ lancamento.comprovante }}" target="_blank" 
                                           class="btn btn-sm btn-outline-info" 
                                           title="Ver comprovante: {{ lancamento.nome_arquivo_comprovante() }}">
                                            {% if lancamento.is_comprovante_imagem() %}
                                                <i class="fas fa-image"></i>
                                            {% elif lancamento.is_comprovante_pdf() %}
                                                <i class="fas fa-file-pdf"></i>
                                            {% else %}
                                                <i class="fas fa-paperclip"></i>
                                            {% endif %}
                                        </a>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('financeiro.editar_lancamento', id=lancamento.id) }}" 
                                               class="btn btn-sm btn-outline-primary" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{{ url_for('financeiro.excluir_lancamento', id=lancamento.id) }}" 
                                               class="btn btn-sm btn-outline-danger" 
                                               title="Excluir"
                                               onclick="return confirm('Tem certeza que deseja excluir este lançamento?')">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="scroll-hint">
                        <i class="fas fa-arrows-alt-h me-1"></i> Role horizontalmente para ver todas as colunas
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-money-bill-wave fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">Nenhum lançamento encontrado</h4>
                    <p class="text-muted">Comece criando seu primeiro lançamento financeiro.</p>
                    <a href="{{ url_for('financeiro.novo_lancamento') }}" class="btn btn-success">
                        <i class="fas fa-plus"></i> Criar Primeiro Lançamento
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Função para aplicar filtro de mês atual
function filtroMesAtual() {
    const hoje = new Date();
    const ano = hoje.getFullYear();
    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
    
    document.getElementById('data_inicial').value = `${ano}-${mes}-01`;
    document.getElementById('data_final').value = `${ano}-${mes}-${new Date(ano, mes, 0).getDate()}`;
    document.getElementById('formFiltros').submit();
}

// Função para aplicar filtro dos últimos 30 dias
function filtroUltimos30Dias() {
    const hoje = new Date();
    const dias30Atras = new Date(hoje.getTime() - (30 * 24 * 60 * 60 * 1000));
    
    document.getElementById('data_inicial').value = dias30Atras.toISOString().split('T')[0];
    document.getElementById('data_final').value = hoje.toISOString().split('T')[0];
    document.getElementById('formFiltros').submit();
}

// Função para filtrar apenas entradas
function filtroEntradas() {
    document.getElementById('tipo').value = 'Entrada';
    document.getElementById('formFiltros').submit();
}

// Função para filtrar apenas saídas
function filtroSaidas() {
    document.getElementById('tipo').value = 'Saída';
    document.getElementById('formFiltros').submit();
}

// Formatar campos de valor com máscara
function formatarValor(input) {
    let valor = input.value.replace(/\D/g, '');
    valor = (valor / 100).toFixed(2) + '';
    valor = valor.replace('.', ',');
    valor = valor.replace(/(\d)(\d{3})(\d{3}),/g, '$1.$2.$3,');
    valor = valor.replace(/(\d)(\d{3}),/g, '$1.$2,');
    input.value = valor;
}

// Validar formulário antes do envio
function validarFormulario() {
    const dataInicial = document.getElementById('data_inicial').value;
    const dataFinal = document.getElementById('data_final').value;
    const valorMin = document.getElementById('valor_min').value;
    const valorMax = document.getElementById('valor_max').value;
    
    // Validar datas
    if (dataInicial && dataFinal && new Date(dataInicial) > new Date(dataFinal)) {
        alert('A data inicial não pode ser maior que a data final!');
        return false;
    }
    
    // Validar valores
    if (valorMin && valorMax) {
        const min = parseFloat(valorMin.replace(',', '.'));
        const max = parseFloat(valorMax.replace(',', '.'));
        if (min > max) {
            alert('O valor mínimo não pode ser maior que o valor máximo!');
            return false;
        }
    }
    
    return true;
}

// Aplicar máscara nos campos de valor
document.addEventListener('DOMContentLoaded', function() {
    const valorMinInput = document.getElementById('valor_min');
    const valorMaxInput = document.getElementById('valor_max');
    
    if (valorMinInput) {
        valorMinInput.addEventListener('input', function() {
            formatarValor(this);
        });
    }
    
    if (valorMaxInput) {
        valorMaxInput.addEventListener('input', function() {
            formatarValor(this);
        });
    }
    
    // Aplicar validação no formulário
    document.getElementById('formFiltros').addEventListener('submit', function(e) {
        if (!validarFormulario()) {
            e.preventDefault();
        }
    });
    
    // Controlar expansão dos filtros avançados
    const btnExpandir = document.querySelector('[data-bs-target="#filtrosAvancados"]');
    const icone = btnExpandir.querySelector('i');
    
    document.getElementById('filtrosAvancados').addEventListener('shown.bs.collapse', function () {
        icone.className = 'fas fa-chevron-up me-1';
        btnExpandir.innerHTML = '<i class="fas fa-chevron-up me-1"></i> Recolher Filtros';
    });
    
    document.getElementById('filtrosAvancados').addEventListener('hidden.bs.collapse', function () {
        icone.className = 'fas fa-chevron-down me-1';
        btnExpandir.innerHTML = '<i class="fas fa-chevron-down me-1"></i> Expandir Filtros';
    });
});

// Ativar tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}