{% extends "base.html" %}

{% block title %}Caixa de Destinações - Sistema OBPC{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Cabeçalho -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white">
                    <h3 class="mb-2"><i class="fas fa-box-open me-2"></i>Caixa de Destinações</h3>
                    <p class="mb-0">Controle separado de valores destinados a projetos específicos</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtro de Período -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('financeiro.caixa_destinacoes') }}" class="row g-3">
                        <div class="col-md-4">
                            <label for="mes" class="form-label">Mês</label>
                            <select class="form-select" id="mes" name="mes">
                                <option value="">Todos</option>
                                {% for m in range(1, 13) %}
                                <option value="{{ m }}" {% if m == mes %}selected{% endif %}>
                                    {{ ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                                        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][m-1] }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="ano" class="form-label">Ano</label>
                            <select class="form-select" id="ano" name="ano">
                                {% for a in range(2020, 2031) %}
                                <option value="{{ a }}" {% if a == ano %}selected{% endif %}>{{ a }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-filter me-2"></i>Filtrar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de Resumo -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm border-0 h-100" style="border-left: 4px solid #28a745 !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">ENTRADAS DESTINADAS</h6>
                            <h3 class="mb-0 text-success">R$ {{ "%.2f"|format(totais.entradas)|replace('.', ',') }}</h3>
                        </div>
                        <div class="fs-1 text-success opacity-25">
                            <i class="fas fa-arrow-circle-down"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0 h-100" style="border-left: 4px solid #dc3545 !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">SAÍDAS (DESTINAÇÕES)</h6>
                            <h3 class="mb-0 text-danger">R$ {{ "%.2f"|format(totais.saidas)|replace('.', ',') }}</h3>
                        </div>
                        <div class="fs-1 text-danger opacity-25">
                            <i class="fas fa-arrow-circle-up"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0 h-100" style="border-left: 4px solid #007bff !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">SALDO DISPONÍVEL</h6>
                            <h3 class="mb-0 {% if totais.saldo >= 0 %}text-primary{% else %}text-danger{% endif %}">
                                R$ {{ "%.2f"|format(totais.saldo)|replace('.', ',') }}
                            </h3>
                        </div>
                        <div class="fs-1 text-primary opacity-25">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informações Importantes -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Como funciona o Caixa de Destinações?</h5>
                <hr>
                <p class="mb-2"><strong>Entradas nos Projetos:</strong></p>
                <ul class="mb-2">
                    <li>Lançamentos de <strong>"Outras Ofertas"</strong> destinados a projetos específicos</li>
                    <li>Lançamentos de <strong>"DESTINAÇÃO"</strong> que transferem recursos do caixa geral para o projeto (ex: anistia dos 30%)</li>
                </ul>
                <p class="mb-2"><strong>Saídas dos Projetos:</strong> Gastos efetivos do projeto (materiais, serviços, etc)</p>
                <p class="mb-0"><strong>Importante:</strong> Lançamentos de DESTINAÇÃO <strong>saem do caixa geral</strong> mas <strong>entram no projeto</strong>, mantendo a contabilidade transparente</p>
            </div>
        </div>
    </div>

    <!-- Tabela de Lançamentos -->
    <div class="row">
        <div class="col-12">
            {% if projetos %}
                <!-- Cards de Projetos -->
                {% for item in projetos %}
                <div class="card shadow-sm mb-4">
                    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="d-flex justify-content-between align-items-center text-white">
                            <div>
                                <h5 class="mb-1"><i class="fas fa-project-diagram me-2"></i>{{ item.projeto.nome }}</h5>
                                <small>{{ item.projeto.tipo }} • Status: {{ item.projeto.status }}</small>
                            </div>
                            <div class="text-end">
                                <h4 class="mb-0">R$ {{ "%.2f"|format(item.totais.saldo)|replace('.', ',') }}</h4>
                                <small>Saldo do Projeto</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Resumo do Projeto -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="text-center p-2 bg-success bg-opacity-10 rounded">
                                    <small class="text-muted d-block">Entradas</small>
                                    <strong class="text-success">R$ {{ "%.2f"|format(item.totais.entradas)|replace('.', ',') }}</strong>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-2 bg-danger bg-opacity-10 rounded">
                                    <small class="text-muted d-block">Saídas</small>
                                    <strong class="text-danger">R$ {{ "%.2f"|format(item.totais.saidas)|replace('.', ',') }}</strong>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-2 bg-primary bg-opacity-10 rounded">
                                    <small class="text-muted d-block">Saldo</small>
                                    <strong class="text-primary">R$ {{ "%.2f"|format(item.totais.saldo)|replace('.', ',') }}</strong>
                                </div>
                            </div>
                        </div>

                        {% if item.projeto.meta_valor and item.totais.percentual %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <small>Progresso da Meta</small>
                                <small>{{ "%.1f"|format(item.totais.percentual) }}%</small>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" role="progressbar" 
                                     style="width: {{ [item.totais.percentual, 100]|min }}%">
                                    {{ "%.1f"|format(item.totais.percentual) }}%
                                </div>
                            </div>
                            <small class="text-muted">Meta: R$ {{ "%.2f"|format(item.projeto.meta_valor)|replace('.', ',') }}</small>
                        </div>
                        {% endif %}

                        <!-- Lançamentos do Projeto -->
                        {% if item.lancamentos %}
                        <h6 class="mt-3 mb-2"><i class="fas fa-list me-2"></i>Lançamentos</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Data</th>
                                        <th>Descrição</th>
                                        <th>Tipo</th>
                                        <th>Categoria</th>
                                        <th class="text-end">Valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for lancamento in item.lancamentos %}
                                    <tr>
                                        <td>{{ lancamento.data.strftime('%d/%m/%Y') }}</td>
                                        <td>{{ lancamento.descricao }}</td>
                                        <td>
                                            {% if lancamento.tipo == 'Entrada' %}
                                                <span class="badge bg-success">Entrada</span>
                                            {% else %}
                                                <span class="badge bg-danger">Saída</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ lancamento.categoria }}</td>
                                        <td class="text-end {% if lancamento.tipo == 'Entrada' %}text-success{% else %}text-danger{% endif %}">
                                            {% if lancamento.tipo == 'Entrada' %}+{% else %}-{% endif %}
                                            R$ {{ "%.2f"|format(lancamento.valor)|replace('.', ',') }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                            <small>Nenhum lançamento neste período</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                <!-- Lançamentos sem Projeto (Legado) -->
                {% if lancamentos_sem_projeto %}
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i>Lançamentos sem Projeto</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Data</th>
                                        <th>Descrição</th>
                                        <th>Tipo</th>
                                        <th>Categoria</th>
                                        <th class="text-end">Valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for lancamento in lancamentos_sem_projeto %}
                                    <tr>
                                        <td>{{ lancamento.data.strftime('%d/%m/%Y') }}</td>
                                        <td>{{ lancamento.descricao }}</td>
                                        <td>
                                            {% if lancamento.tipo == 'Entrada' %}
                                                <span class="badge bg-success">Entrada</span>
                                            {% else %}
                                                <span class="badge bg-danger">Saída</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ lancamento.categoria }}</td>
                                        <td class="text-end {% if lancamento.tipo == 'Entrada' %}text-success{% else %}text-danger{% endif %}">
                                            {% if lancamento.tipo == 'Entrada' %}+{% else %}-{% endif %}
                                            R$ {{ "%.2f"|format(lancamento.valor)|replace('.', ',') }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% else %}
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3 d-block"></i>
                        <h5>Nenhum projeto cadastrado</h5>
                        <p class="text-muted">Crie projetos em "Gerenciar Projetos" para começar a controlar destinações</p>
                        <a href="{{ url_for('financeiro.lista_projetos') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Criar Projeto
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
