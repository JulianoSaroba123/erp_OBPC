{% extends "base.html" %}

{% block title %}Relatório de Caixa - OBPC{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho para impressão -->
    <div class="d-print-block text-center mb-4">
        <h2 class="text-primary">OBPC - O Brasil para Cristo</h2>
        <h3>Tietê - SP</h3>
        <h4 class="mt-3">RELATÓRIO DE CAIXA INTERNO</h4>
        <p class="text-muted">
            Mês: {{ "%02d"|format(mes) }}/{{ ano }} | 
            Gerado em: {{ data_geracao.strftime('%d/%m/%Y às %H:%M') }}
        </p>
    </div>

    <!-- Controles (não imprime) -->
    <div class="d-print-none mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2><i class="fas fa-cash-register text-primary me-2"></i>Relatório de Caixa - {{ "%02d"|format(mes) }}/{{ ano }}</h2>
            </div>
            <div class="col-md-4">
                <div class="d-flex justify-content-end gap-2">
                    <!-- Dropdown Período -->
                    <div class="dropdown">
                        <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-calendar me-1"></i> Período
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            {% for m in range(1, 13) %}
                            <li><a class="dropdown-item {% if m == mes %}active{% endif %}" href="{{ url_for('financeiro.relatorio_caixa', mes=m, ano=ano) }}">
                                {{ "%02d"|format(m) }}/{{ ano }}
                            </a></li>
                            {% endfor %}
                        </ul>
                    </div>
                    
                    <!-- Botão Voltar -->
                    <a href="{{ url_for('financeiro.lista_lancamentos') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i> Voltar
                    </a>
                    
                    <!-- Botões Principais -->
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('financeiro.relatorio_caixa_pdf', mes=mes, ano=ano) }}" 
                           class="btn btn-success" target="_blank" title="Gerar PDF Profissional">
                            <i class="fas fa-file-pdf me-1"></i> PDF
                        </a>
                        <button onclick="window.print()" class="btn btn-primary" title="Imprimir Relatório">
                            <i class="fas fa-print me-1"></i> Imprimir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Relatório de Caixa -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calculator me-2"></i>
                        Resumo Mensal de Caixa - {{ "%02d"|format(mes) }}/{{ ano }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Coluna 1: Entradas -->
                        <div class="col-md-6">
                            <h6 class="text-primary fw-bold mb-3">
                                <i class="fas fa-arrow-up"></i> ENTRADAS
                            </h6>
                            
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Total Entradas Banco:</strong></td>
                                    <td class="text-end text-primary fw-bold">
                                        {{ "R$ %.2f"|format(totais.entradas_banco)|replace(".", ",") }}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Total Entradas Dinheiro:</strong></td>
                                    <td class="text-end text-primary fw-bold">
                                        {{ "R$ %.2f"|format(totais.entradas_dinheiro)|replace(".", ",") }}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Total Entradas PIX:</strong></td>
                                    <td class="text-end text-primary fw-bold">
                                        {{ "R$ %.2f"|format(totais.entradas_pix)|replace(".", ",") }}
                                    </td>
                                </tr>
                                <tr class="table-light">
                                    <td><strong>TOTAL ENTRADAS:</strong></td>
                                    <td class="text-end text-primary fw-bold fs-5">
                                        {{ "R$ %.2f"|format(totais.total_entradas)|replace(".", ",") }}
                                    </td>
                                </tr>
                            </table>

                            <h6 class="text-success fw-bold mt-4 mb-3">
                                <i class="fas fa-hand-holding-heart"></i> DÍZIMOS
                            </h6>
                            
                            <table class="table table-sm">
                                <tr>
                                    <td>Dízimos Banco:</td>
                                    <td class="text-end text-success fw-bold">
                                        {{ "R$ %.2f"|format(totais.dizimos_banco)|replace(".", ",") }}
                                    </td>
                                </tr>
                                <tr>
                                    <td>Dízimos Dinheiro:</td>
                                    <td class="text-end text-success fw-bold">
                                        {{ "R$ %.2f"|format(totais.dizimos_dinheiro)|replace(".", ",") }}
                                    </td>
                                </tr>
                                <tr>
                                    <td>Dízimos PIX:</td>
                                    <td class="text-end text-success fw-bold">
                                        {{ "R$ %.2f"|format(totais.dizimos_pix)|replace(".", ",") }}
                                    </td>
                                </tr>
                                <tr class="table-light">
                                    <td><strong>TOTAL DÍZIMOS:</strong></td>
                                    <td class="text-end text-success fw-bold">
                                        {{ "R$ %.2f"|format(totais.dizimos_banco + totais.dizimos_dinheiro + totais.dizimos_pix)|replace(".", ",") }}
                                    </td>
                                </tr>
                            </table>

                            <h6 class="text-info fw-bold mt-4 mb-3">
                                <i class="fas fa-gift"></i> OFERTAS
                            </h6>
                            
                            <table class="table table-sm">
                                <tr>
                                    <td>Ofertas Banco:</td>
                                    <td class="text-end text-info fw-bold">
                                        {{ "R$ %.2f"|format(totais.ofertas_banco)|replace(".", ",") }}
                                    </td>
                                </tr>
                                <tr>
                                    <td>Ofertas Dinheiro:</td>
                                    <td class="text-end text-info fw-bold">
                                        {{ "R$ %.2f"|format(totais.ofertas_dinheiro)|replace(".", ",") }}
                                    </td>
                                </tr>
                                <tr>
                                    <td>Ofertas PIX:</td>
                                    <td class="text-end text-info fw-bold">
                                        {{ "R$ %.2f"|format(totais.ofertas_pix)|replace(".", ",") }}
                                    </td>
                                </tr>
                                <tr class="table-light">
                                    <td><strong>TOTAL OFERTAS:</strong></td>
                                    <td class="text-end text-info fw-bold">
                                        {{ "R$ %.2f"|format(totais.ofertas_banco + totais.ofertas_dinheiro + totais.ofertas_pix)|replace(".", ",") }}
                                    </td>
                                </tr>
                            </table>
                        </div>

                        <!-- Coluna 2: Saídas e Saldos -->
                        <div class="col-md-6">
                            <h6 class="text-danger fw-bold mb-3">
                                <i class="fas fa-arrow-down"></i> SAÍDAS
                            </h6>
                            
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Total Saídas Banco:</strong></td>
                                    <td class="text-end text-danger fw-bold">
                                        {{ "R$ %.2f"|format(totais.saidas_banco)|replace(".", ",") }}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Total Saídas Dinheiro:</strong></td>
                                    <td class="text-end text-danger fw-bold">
                                        {{ "R$ %.2f"|format(totais.saidas_dinheiro)|replace(".", ",") }}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Total Descontos:</strong></td>
                                    <td class="text-end text-warning fw-bold">
                                        {{ "R$ %.2f"|format(totais.descontos)|replace(".", ",") }}
                                    </td>
                                </tr>
                                <tr class="table-light">
                                    <td><strong>TOTAL SAÍDAS:</strong></td>
                                    <td class="text-end text-danger fw-bold fs-5">
                                        {{ "R$ %.2f"|format(totais.total_saidas)|replace(".", ",") }}
                                    </td>
                                </tr>
                            </table>

                            <h6 class="text-dark fw-bold mt-4 mb-3">
                                <i class="fas fa-balance-scale"></i> SALDOS
                            </h6>
                            
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Saldo Anterior:</strong></td>
                                    <td class="text-end fw-bold">
                                        {{ "R$ %.2f"|format(totais.saldo_anterior)|replace(".", ",") }}
                                        <br><small class="text-muted">(Acumulado até {% if mes == 1 %}12/{{ ano-1 }}{% else %}{{ "%02d"|format(mes-1) }}/{{ ano }}{% endif %})</small>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Saldo do Mês:</strong></td>
                                    <td class="text-end {% if totais.saldo_mes >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                        {{ "R$ %.2f"|format(totais.saldo_mes)|replace(".", ",") }}
                                    </td>
                                </tr>
                                <tr class="table-secondary">
                                    <td><strong>SALDO ACUMULADO:</strong></td>
                                    <td class="text-end {% if totais.saldo_acumulado >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold fs-5">
                                        {{ "R$ %.2f"|format(totais.saldo_acumulado)|replace(".", ",") }}
                                    </td>
                                </tr>
                            </table>

                            <!-- Gráfico Resumo Visual -->
                            <div class="mt-4">
                                <h6 class="text-dark fw-bold mb-3">
                                    <i class="fas fa-chart-pie"></i> RESUMO VISUAL
                                </h6>
                                <div class="progress mb-2" style="height: 25px;">
                                    {% set percentual_entradas = (totais.total_entradas / (totais.total_entradas + totais.total_saidas) * 100) if (totais.total_entradas + totais.total_saidas) > 0 else 0 %}
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: {{ percentual_entradas }}%;" 
                                         aria-valuenow="{{ percentual_entradas }}" 
                                         aria-valuemin="0" aria-valuemax="100">
                                        Entradas: {{ "%.1f"|format(percentual_entradas) }}%
                                    </div>
                                    <div class="progress-bar bg-danger" role="progressbar" 
                                         style="width: {{ 100 - percentual_entradas }}%;" 
                                         aria-valuenow="{{ 100 - percentual_entradas }}" 
                                         aria-valuemin="0" aria-valuemax="100">
                                        Saídas: {{ "%.1f"|format(100 - percentual_entradas) }}%
                                    </div>
                                </div>
                                <small class="text-muted">
                                    Relação entre entradas e saídas do mês
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rodapé para impressão -->
    <div class="d-print-block mt-5">
        <hr>
        <div class="row text-center">
            <div class="col-6">
                <p class="mb-1"><strong>_________________________________</strong></p>
                <p class="small">Tesoureiro: Maria Santos</p>
            </div>
            <div class="col-6">
                <p class="mb-1"><strong>_________________________________</strong></p>
                <p class="small">Dirigente: Pastor João Silva</p>
            </div>
        </div>
        <p class="text-center text-muted small mt-3">
            Sistema Administrativo OBPC - {{ data_geracao.strftime('%d/%m/%Y às %H:%M') }}
        </p>
    </div>
</div>

<style>
@media print {
    .d-print-none {
        display: none !important;
    }
    
    .d-print-block {
        display: block !important;
    }
    
    .card {
        border: 1px solid #000 !important;
        break-inside: avoid;
    }
    
    .table {
        break-inside: avoid;
    }
    
    body {
        font-size: 12px;
    }
    
    h2, h3, h4, h5, h6 {
        color: #000 !important;
    }
    
    .text-primary, .text-success, .text-danger, .text-warning, .text-info {
        color: #000 !important;
    }
    
    .bg-primary, .bg-success, .bg-danger, .bg-warning, .bg-info {
        background-color: #f8f9fa !important;
        color: #000 !important;
    }
}
</style>
{% endblock %}