{% extends "base.html" %}

{% block title %}{% if lancamento %}Editar{% else %}Novo{% endif %} Lan√ßamento - OBPC{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-{% if lancamento %}edit{% else %}plus{% endif %} me-2"></i>
                        {% if lancamento %}Editar{% else %}Novo{% endif %} Lan√ßamento
                    </h5>
                </div>
                <div class="card-body">
                    <form id="form-lancamento" method="POST" action="{{ url_for('financeiro.salvar_lancamento') }}" enctype="multipart/form-data">
                        {% if lancamento %}
                        <input type="hidden" name="id" value="{{ lancamento.id }}">
                        {% endif %}
                        
                        <div class="row">
                            <!-- Data do Lan√ßamento -->
                            <div class="col-md-6 mb-3">
                                <label for="data" class="form-label">Data do Lan√ßamento *</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="data" 
                                       name="data" 
                                       value="{% if lancamento %}{{ lancamento.data.strftime('%Y-%m-%d') }}{% else %}{{ today.strftime('%Y-%m-%d') if today else '' }}{% endif %}"
                                       required>
                            </div>

                            <!-- Tipo -->
                            <div class="col-md-6 mb-3">
                                <label for="tipo" class="form-label">Tipo *</label>
                                <select class="form-select" id="tipo" name="tipo" required>
                                    <option value="">Selecione o tipo</option>
                                    <option value="Entrada" {% if lancamento and lancamento.tipo == 'Entrada' %}selected{% endif %}>
                                        <i class="fas fa-arrow-up"></i> Entrada
                                    </option>
                                    <option value="Sa√≠da" {% if lancamento and lancamento.tipo == 'Sa√≠da' %}selected{% endif %}>
                                        <i class="fas fa-arrow-down"></i> Sa√≠da
                                    </option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Categoria -->
                            <div class="col-md-6 mb-3">
                                <label for="categoria" class="form-label">Categoria *</label>
                                <select class="form-select" id="categoria" name="categoria" required>
                                    <option value="">Selecione a categoria</option>
                                    
                                    <!-- Entradas -->
                                    <optgroup label="üí∞ ENTRADAS">
                                        <option value="D√çZIMO" {% if lancamento and lancamento.categoria == 'D√çZIMO' %}selected{% endif %}>D√çZIMO</option>
                                        <option value="OFERTA" {% if lancamento and lancamento.categoria == 'OFERTA' %}selected{% endif %}>OFERTA</option>
                                        <option value="OFERTA OMN" {% if lancamento and lancamento.categoria == 'OFERTA OMN' %}selected{% endif %}>OFERTA OMN</option>
                                        <option value="OUTRAS OFERTAS" {% if lancamento and lancamento.categoria == 'OUTRAS OFERTAS' %}selected{% endif %}>OUTRAS OFERTAS</option>
                                        <option value="RENDIMENTOS" {% if lancamento and lancamento.categoria == 'RENDIMENTOS' %}selected{% endif %}>RENDIMENTOS</option>
                                    </optgroup>
                                    
                                    <!-- Sa√≠das -->
                                    <optgroup label="SA√çDAS">
                                        <option value="DESP. FIXAS" {% if lancamento and lancamento.categoria == 'DESP. FIXAS' %}selected{% endif %}>DESP. FIXAS</option>
                                        <option value="DESP. VARIAVEIS" {% if lancamento and lancamento.categoria == 'DESP. VARIAVEIS' %}selected{% endif %}>DESP. VARIAVEIS</option>
                                        <option value="PREBENDA" {% if lancamento and lancamento.categoria == 'PREBENDA' %}selected{% endif %}>PREBENDA</option>
                                        <option value="COMBUST√çVEL" {% if lancamento and lancamento.categoria == 'COMBUST√çVEL' %}selected{% endif %}>COMBUST√çVEL</option>
                                        <option value="REND.CONTA" {% if lancamento and lancamento.categoria == 'REND.CONTA' %}selected{% endif %}>REND.CONTA</option>
                                        <option value="AJUDA CUSTO" {% if lancamento and lancamento.categoria == 'AJUDA CUSTO' %}selected{% endif %}>AJUDA CUSTO</option>
                                        <option value="TRANSP VIEX" {% if lancamento and lancamento.categoria == 'TRANSP VIEX' %}selected{% endif %}>TRANSP VIEX</option>
                                        <option value="CONTAS" {% if lancamento and lancamento.categoria == 'CONTAS' %}selected{% endif %}>CONTAS</option>
                                        <option value="CR√âDITO CART√ÉO" {% if lancamento and lancamento.categoria == 'CR√âDITO CART√ÉO' %}selected{% endif %}>CR√âDITO CART√ÉO</option>
                                        <option value="DESC.CONTA" {% if lancamento and lancamento.categoria == 'DESC.CONTA' %}selected{% endif %}>DESC.CONTA</option>
                                        <option value="DESTINA√á√ÉO" {% if lancamento and lancamento.categoria == 'DESTINA√á√ÉO' %}selected{% endif %}>DESTINA√á√ÉO</option>
                                        <option value="GASTO PROJETO" {% if lancamento and lancamento.categoria == 'GASTO PROJETO' %}selected{% endif %}>GASTO PROJETO</option>
                                    </optgroup>
                                </select>
                                <div class="form-text">Selecione a categoria apropriada para o lan√ßamento</div>
                            </div>

                            <!-- Projeto (aparece apenas para OUTRAS OFERTAS e DESTINA√á√ÉO) -->
                            <div class="col-md-6 mb-3" id="campo-projeto" style="display: none;">
                                <label for="projeto_id" class="form-label">Projeto <span id="projeto-label-extra"></span></label>
                                <select class="form-select" id="projeto_id" name="projeto_id">
                                    <option value="">Nenhum projeto</option>
                                    {% for projeto in projetos %}
                                    <option value="{{ projeto.id }}" 
                                            {% if lancamento and lancamento.projeto_id == projeto.id %}selected{% endif %}
                                            data-saldo="{{ projeto.calcular_totais()['saldo'] }}">
                                        {{ projeto.nome }} 
                                        {% if projeto.status != 'Ativo' %}({{ projeto.status }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text" id="projeto-help-text">Vincule este lan√ßamento a um projeto espec√≠fico</div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Valor -->
                            <div class="col-md-6 mb-3">
                                <label for="valor" class="form-label">Valor *</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" 
                                           class="form-control" 
                                           id="valor" 
                                           name="valor" 
                                           value="{% if lancamento %}{{ '%.2f'|format(lancamento.valor)|replace('.', ',') }}{% endif %}"
                                           placeholder="0,00"
                                           required>
                                </div>
                                <div class="form-text">Use v√≠rgula para separar os centavos (ex: 1.500,50)</div>
                            </div>

                            <!-- Conta -->
                            <div class="col-md-6 mb-3">
                                <label for="conta" class="form-label">Conta *</label>
                                <select class="form-select" id="conta" name="conta" required>
                                    <option value="">Selecione a conta</option>
                                    <option value="Dinheiro" {% if lancamento and lancamento.conta == 'Dinheiro' %}selected{% endif %}>
                                        üí∞ Dinheiro
                                    </option>
                                    <option value="Banco" {% if lancamento and lancamento.conta == 'Banco' %}selected{% endif %}>
                                        üè¶ Banco
                                    </option>
                                    <option value="Poupan√ßa" {% if lancamento and lancamento.conta == 'Poupan√ßa' %}selected{% endif %}>
                                        üí≥ Poupan√ßa
                                    </option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Descri√ß√£o -->
                            <div class="col-md-6 mb-3">
                                <label for="descricao" class="form-label">Descri√ß√£o</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="descricao" 
                                       name="descricao" 
                                       value="{{ lancamento.descricao if lancamento else '' }}"
                                       placeholder="Breve descri√ß√£o do lan√ßamento">
                            </div>
                        </div>

                        <!-- Observa√ß√µes -->
                        <div class="mb-3">
                            <label for="observacoes" class="form-label">Observa√ß√µes</label>
                            <textarea class="form-control" 
                                      id="observacoes" 
                                      name="observacoes" 
                                      rows="3" 
                                      placeholder="Informa√ß√µes adicionais sobre o lan√ßamento (opcional)">{% if lancamento and lancamento.observacoes and lancamento.observacoes != 'None' %}{{ lancamento.observacoes }}{% endif %}</textarea>
                        </div>

                        <!-- Comprovante -->
                        <div class="mb-3">
                            <label for="comprovante" class="form-label">Comprovante</label>
                            <input type="file" 
                                   class="form-control" 
                                   id="comprovante" 
                                   name="comprovante"
                                   accept=".jpg,.jpeg,.png,.pdf">
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i> 
                                Formatos aceitos: JPG, PNG, PDF (m√°x. 5MB)
                            </div>
                            
                            {% if lancamento and lancamento.tem_comprovante() %}
                            <div class="mt-2">
                                <div class="alert alert-info d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-paperclip me-2"></i>
                                        <div>
                                            <strong>Comprovante atual:</strong> 
                                            <a href="{{ lancamento.comprovante }}" target="_blank" class="alert-link">
                                                {{ lancamento.nome_arquivo_comprovante() }}
                                            </a>
                                            {% if lancamento.is_comprovante_imagem() %}
                                                <i class="fas fa-image text-primary ms-1"></i>
                                            {% elif lancamento.is_comprovante_pdf() %}
                                                <i class="fas fa-file-pdf text-danger ms-1"></i>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <form method="POST" action="{{ url_for('financeiro.excluir_comprovante', id=lancamento.id) }}" 
                                          onsubmit="return confirm('Tem certeza que deseja excluir este comprovante?');" 
                                          class="mb-0">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir comprovante">
                                            <i class="fas fa-trash-alt"></i> Excluir
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Bot√µes -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('financeiro.lista_lancamentos') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </a>
                            <button id="btn-submit-lancamento" type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> 
                                {% if lancamento %}Atualizar{% else %}Salvar{% endif %} Lan√ßamento
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Card de Ajuda -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Dicas de Preenchimento</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success"><i class="fas fa-arrow-up"></i> Entradas</h6>
                            <ul class="small text-muted">
                                <li>D√≠zimos e Ofertas</li>
                                <li>Doa√ß√µes</li>
                                <li>Eventos e Campanhas</li>
                                <li>Rendimentos</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-danger"><i class="fas fa-arrow-down"></i> Sa√≠das</h6>
                            <ul class="small text-muted">
                                <li>Despesas Operacionais</li>
                                <li>Manuten√ß√£o e Reformas</li>
                                <li>Pagamentos a Fornecedores</li>
                                <li>Combust√≠vel e Transporte</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM carregado - iniciando scripts');
    
    // Se estiver editando, configurar data padr√£o para hoje
    {% if not lancamento %}
    const dataInput = document.getElementById('data');
    if (!dataInput.value) {
        const hoje = new Date().toISOString().split('T')[0];
        dataInput.value = hoje;
    }
    {% endif %}

    // Mudan√ßa de cor do tipo e sugest√£o de categorias
    const tipoSelect = document.getElementById('tipo');
    const categoriaSelect = document.getElementById('categoria');
    
    // === CONTROLE DO CAMPO PROJETO (IN√çCIO) ===
    const campoProjetoDiv = document.getElementById('campo-projeto');
    const projetoSelect = document.getElementById('projeto_id');
    const projetoLabelExtra = document.getElementById('projeto-label-extra');
    
    console.log('Elementos encontrados:', {
        campoProjetoDiv: !!campoProjetoDiv,
        categoriaSelect: !!categoriaSelect,
        projetoSelect: !!projetoSelect
    });
    
    function atualizarCampoProjeto() {
        if (!categoriaSelect || !campoProjetoDiv) {
            console.error('Elementos n√£o encontrados!');
            return;
        }
        
        const categoriaSelecionada = categoriaSelect.value;
        const categoriasComProjeto = ['OUTRAS OFERTAS', 'DESTINA√á√ÉO', 'GASTO PROJETO'];
        
        console.log('Atualizando campo projeto. Categoria:', categoriaSelecionada);
        
        if (categoriasComProjeto.includes(categoriaSelecionada)) {
            console.log('‚úÖ Mostrando campo de projeto');
            campoProjetoDiv.style.display = 'block';
            
            if (categoriaSelecionada === 'OUTRAS OFERTAS') {
                projetoLabelExtra.textContent = '(Opcional)';
                projetoSelect.removeAttribute('required');
            } else if (categoriaSelecionada === 'DESTINA√á√ÉO' || categoriaSelecionada === 'GASTO PROJETO') {
                projetoLabelExtra.textContent = '*';
                projetoSelect.setAttribute('required', 'required');
            }
        } else {
            console.log('‚ùå Ocultando campo de projeto');
            campoProjetoDiv.style.display = 'none';
            projetoSelect.removeAttribute('required');
            projetoSelect.value = '';
        }
    }
    
    // Aplicar ao carregar
    if (categoriaSelect) {
        atualizarCampoProjeto();
        categoriaSelect.addEventListener('change', atualizarCampoProjeto);
        console.log('Event listener adicionado √† categoria');
    }
    // === CONTROLE DO CAMPO PROJETO (FIM) ===
    
    tipoSelect.addEventListener('change', function() {
        const card = this.closest('.card');
        if (this.value === 'Entrada') {
            card.querySelector('.card-header').className = 'card-header bg-success text-white';
            // Sugerir categorias de entrada
            mostrarCategoriasEntrada();
        } else if (this.value === 'Sa√≠da') {
            card.querySelector('.card-header').className = 'card-header bg-danger text-white';
            // Sugerir categorias de sa√≠da
            mostrarCategoriasSaida();
        } else {
            card.querySelector('.card-header').className = 'card-header';
            mostrarTodasCategorias();
        }
    });
    
    function mostrarCategoriasEntrada() {
        // Mostrar apenas categorias de entrada
        const optgroups = categoriaSelect.querySelectorAll('optgroup');
        optgroups.forEach(group => {
            const label = group.getAttribute('label');
            if (label.includes('ENTRADAS')) {
                group.style.display = 'block';
            } else {
                group.style.display = 'none';
            }
        });
    }
    
    function mostrarCategoriasSaida() {
        // Mostrar apenas categorias de sa√≠da
        const optgroups = categoriaSelect.querySelectorAll('optgroup');
        optgroups.forEach(group => {
            const label = group.getAttribute('label');
            if (label.includes('SA√çDAS')) {
                group.style.display = 'block';
            } else {
                group.style.display = 'none';
            }
        });
    }
    
    function mostrarTodasCategorias() {
        // Mostrar todos os optgroups
        const optgroups = categoriaSelect.querySelectorAll('optgroup');
        optgroups.forEach(group => {
            group.style.display = 'block';
        });
    }

    // N√ÉO aplicar filtro autom√°tico quando estiver editando (categoria j√° selecionada)
    // Apenas aplicar quando for novo lan√ßamento
    {% if not lancamento %}
    if (tipoSelect.value) {
        tipoSelect.dispatchEvent(new Event('change'));
    }
    {% endif %}
    
    // M√°scara de moeda brasileira para o campo valor
    const valorInput = document.getElementById('valor');
    
    function formatarMoeda(valor) {
        // Remove tudo que n√£o √© d√≠gito
        valor = valor.replace(/\D/g, '');
        
        // Se n√£o tem nada, retorna vazio
        if (valor === '') return '';
        
        // Converte para centavos
        valor = parseInt(valor);
        
        // Converte para formato decimal
        valor = (valor / 100).toFixed(2);
        
        // Adiciona separadores de milhares e v√≠rgula decimal
        valor = valor.replace('.', ',');
        valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
        
        return valor;
    }
    
    function aplicarMascaraMoeda(input) {
        const valorOriginal = input.value;
        const valorFormatado = formatarMoeda(valorOriginal);
        
        if (valorOriginal !== valorFormatado) {
            const posicaoAtual = input.selectionStart;
            const diferencaTamanho = valorFormatado.length - valorOriginal.length;
            
            input.value = valorFormatado;
            
            // Ajusta a posi√ß√£o do cursor
            const novaPosicao = posicaoAtual + diferencaTamanho;
            input.setSelectionRange(novaPosicao, novaPosicao);
        }
    }
    
    // Aplicar m√°scara em tempo real
    valorInput.addEventListener('input', function(e) {
        aplicarMascaraMoeda(this);
    });
    
    // Aplicar m√°scara quando o campo perde o foco
    valorInput.addEventListener('blur', function(e) {
        aplicarMascaraMoeda(this);
        
        // Se o campo est√° vazio, coloca 0,00
        if (this.value === '') {
            this.value = '0,00';
        }
    });
    
    // Aplicar m√°scara quando o campo ganha foco
    valorInput.addEventListener('focus', function(e) {
        // Se o valor √© 0,00, limpa o campo
        if (this.value === '0,00') {
            this.value = '';
        }
    });
    
    // Aplicar m√°scara no valor inicial se existir
    if (valorInput.value) {
        aplicarMascaraMoeda(valorInput);
    }
    
    // Melhorar experi√™ncia para lan√ßamentos m√∫ltiplos
    // Se existe mensagem de sucesso, focar no campo de data para pr√≥ximo lan√ßamento
    setTimeout(function() {
        const successAlert = document.querySelector('.alert-success');
        if (successAlert) {
            const dataInput = document.getElementById('data');
            if (dataInput && !dataInput.disabled) {
                dataInput.focus();
            }
        }
    }, 800);
});
</script>
<script>
// Garantir que o bot√£o dispare o submit mesmo se algum script externo falhar
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('btn-submit-lancamento');
    const form = document.getElementById('form-lancamento');
    if (btn && form) {
        btn.addEventListener('click', function(e) {
            // Se o navegador suportar, usar requestSubmit para respeitar valida√ß√µes HTML5
            if (typeof form.requestSubmit === 'function') {
                e.preventDefault();
                form.requestSubmit();
            } else {
                // Fallback
                form.submit();
            }
        });
    }
});
</script>
{% endblock %}