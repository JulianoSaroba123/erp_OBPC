{% extends "base.html" %}

{% block title %}Gerenciar Despesas Fixas - OBPC{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <!-- Cabeçalho -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-cogs text-primary me-2"></i>Despesas Fixas do Conselho</h2>
                <div>
                    <button type="button" class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#gerarLancamentosModal">
                        <i class="fas fa-magic me-1"></i> Gerar Lançamentos
                    </button>
                    <a href="{{ url_for('financeiro.lista_lancamentos') }}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left me-1"></i> Voltar
                    </a>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#novaDespesaModal">
                        <i class="fas fa-plus me-1"></i> Nova Despesa
                    </button>
                </div>
            </div>

            <!-- Informações Resumo -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title mb-0">Total Despesas Ativas</h6>
                                    <h4 class="mb-0">{{ despesas_ativas|length }}</h4>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-list fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title mb-0">Valor Total Mensal</h6>
                                    <h4 class="mb-0">{{ "R$ %.2f"|format(total_despesas)|replace(".", ",") }}</h4>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-money-bill-wave fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title mb-0">Valor Anual</h6>
                                    <h4 class="mb-0">{{ "R$ %.2f"|format(total_despesas * 12)|replace(".", ",") }}</h4>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-calendar-alt fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela de Despesas -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>Lista de Despesas Fixas</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Nome</th>
                                    <th>Descrição</th>
                                    <th>Categoria</th>
                                    <th class="text-end">Valor</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for despesa in despesas_todas %}
                                <tr class="{% if not despesa.ativo %}table-secondary{% endif %}">
                                    <td>
                                        <strong>{{ despesa.nome }}</strong>
                                        {% if not despesa.ativo %}
                                            <small class="text-muted">(Inativa)</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ despesa.descricao or '-' }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ despesa.categoria or 'Geral' }}</span>
                                    </td>
                                    <td class="text-end">
                                        <strong class="text-success">{{ "R$ %.2f"|format(despesa.valor_padrao)|replace(".", ",") }}</strong>
                                    </td>
                                    <td class="text-center">
                                        {% if despesa.ativo %}
                                            <span class="badge bg-success">Ativa</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inativa</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-primary" 
                                                    onclick="editarDespesa({{ despesa.id }}, '{{ despesa.nome }}', '{{ despesa.descricao }}', '{{ despesa.categoria }}', {{ despesa.valor_padrao }}, {{ despesa.ativo|lower }})"
                                                    title="Editar despesa">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {% if despesa.ativo %}
                                                <a href="{{ url_for('financeiro.toggle_despesa_fixa', id=despesa.id) }}" 
                                                   class="btn btn-outline-warning"
                                                   onclick="return confirm('Desativar esta despesa fixa?')"
                                                   title="Desativar despesa">
                                                    <i class="fas fa-pause"></i>
                                                </a>
                                            {% else %}
                                                <a href="{{ url_for('financeiro.toggle_despesa_fixa', id=despesa.id) }}" 
                                                   class="btn btn-outline-success"
                                                   onclick="return confirm('Reativar esta despesa fixa?')"
                                                   title="Reativar despesa">
                                                    <i class="fas fa-play"></i>
                                                </a>
                                            {% endif %}
                                            <button type="button" class="btn btn-outline-danger" 
                                                    onclick="confirmarExclusao({{ despesa.id }}, '{{ despesa.nome }}')"
                                                    title="Excluir despesa permanentemente">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nova Despesa -->
<div class="modal fade" id="novaDespesaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Nova Despesa Fixa
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('financeiro.gerenciar_despesas_fixas') }}">
                <input type="hidden" name="acao" value="criar">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nome" class="form-label">Nome da Despesa</label>
                        <input type="text" class="form-control" id="nome" name="nome" required 
                               placeholder="Ex: Contador Sede">
                    </div>
                    <div class="mb-3">
                        <label for="descricao" class="form-label">Descrição</label>
                        <textarea class="form-control" id="descricao" name="descricao" rows="2"
                                  placeholder="Descrição detalhada da despesa"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="categoria" class="form-label">Categoria <small class="text-muted">(usada nos lançamentos)</small></label>
                        <select class="form-select" id="categoria" name="categoria" required>
                            <option value="">Selecione uma categoria...</option>
                            {% for cat in categorias_saida %}
                            <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                            <option value="DESP. FIXAS">DESP. FIXAS (Nova)</option>
                        </select>
                        <small class="form-text text-muted">Selecione a categoria de saída que será usada ao gerar lançamentos automáticos</small>
                    </div>
                    <div class="mb-3">
                        <label for="valor_padrao" class="form-label">Valor Mensal (R$)</label>
                        <input type="number" class="form-control" id="valor_padrao" name="valor_padrao" 
                               step="0.01" min="0" required placeholder="0,00">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-1"></i>Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Despesa -->
<div class="modal fade" id="editarDespesaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Editar Despesa Fixa
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('financeiro.gerenciar_despesas_fixas') }}">
                <input type="hidden" name="acao" value="editar">
                <input type="hidden" id="edit_id" name="id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_nome" class="form-label">Nome da Despesa</label>
                        <input type="text" class="form-control" id="edit_nome" name="nome" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_descricao" class="form-label">Descrição</label>
                        <textarea class="form-control" id="edit_descricao" name="descricao" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit_categoria" class="form-label">Categoria <small class="text-muted">(usada nos lançamentos)</small></label>
                        <select class="form-select" id="edit_categoria" name="categoria" required>
                            <option value="">Selecione uma categoria...</option>
                            {% for cat in categorias_saida %}
                            <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                            <option value="DESP. FIXAS">DESP. FIXAS (Nova)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_valor_padrao" class="form-label">Valor Mensal (R$)</label>
                        <input type="number" class="form-control" id="edit_valor_padrao" name="valor_padrao" 
                               step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_ativo" name="ativo" value="1">
                            <label class="form-check-label" for="edit_ativo">
                                Despesa ativa
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Atualizar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Gerar Lançamentos -->
<div class="modal fade" id="gerarLancamentosModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-magic me-2"></i>Gerar Lançamentos Automáticos
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('financeiro.gerar_lancamentos_despesas_fixas') }}">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Como funciona:</strong><br>
                        Esta função cria automaticamente lançamentos de saída para todas as despesas fixas ativas 
                        no mês selecionado. Os lançamentos serão criados com a categoria configurada em cada despesa.
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="mes" class="form-label">Mês</label>
                            <select class="form-select" id="mes" name="mes" required>
                                <option value="1">Janeiro</option>
                                <option value="2">Fevereiro</option>
                                <option value="3">Março</option>
                                <option value="4">Abril</option>
                                <option value="5">Maio</option>
                                <option value="6">Junho</option>
                                <option value="7">Julho</option>
                                <option value="8">Agosto</option>
                                <option value="9">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="ano" class="form-label">Ano</label>
                            <input type="number" class="form-control" id="ano" name="ano" 
                                   value="{{ now.year if now else 2025 }}" min="2020" max="2030" required>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Atenção:</strong> Lançamentos já existentes não serão duplicados.
                    </div>
                    
                    <div class="mb-3">
                        <strong>Despesas ativas que serão lançadas:</strong>
                        <ul class="mt-2">
                            {% for despesa in despesas_ativas %}
                            <li>{{ despesa.nome }} - R$ {{ "%.2f"|format(despesa.valor_padrao)|replace(".", ",") }} 
                                <small class="text-muted">({{ despesa.categoria or 'DESP. FIXAS' }})</small>
                            </li>
                            {% endfor %}
                        </ul>
                        <strong>Total: R$ {{ "%.2f"|format(total_despesas)|replace(".", ",") }}</strong>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-magic me-1"></i>Gerar Lançamentos
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Definir mês atual ao abrir o modal
document.getElementById('gerarLancamentosModal').addEventListener('show.bs.modal', function () {
    const mesAtual = new Date().getMonth() + 1;
    document.getElementById('mes').value = mesAtual;
});

function editarDespesa(id, nome, descricao, categoria, valor, ativo) {
    document.getElementById('edit_id').value = id;
    document.getElementById('edit_nome').value = nome;
    document.getElementById('edit_descricao').value = descricao || '';
    document.getElementById('edit_categoria').value = categoria || '';
    document.getElementById('edit_valor_padrao').value = valor;
    document.getElementById('edit_ativo').checked = ativo;
    
    new bootstrap.Modal(document.getElementById('editarDespesaModal')).show();
}

function confirmarExclusao(id, nome) {
    if (confirm(`ATENÇÃO! Esta ação é PERMANENTE e não poderá ser desfeita.\n\nDeseja realmente EXCLUIR a despesa fixa "${nome}"?`)) {
        // Criar e submeter formulário de exclusão
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/financeiro/despesas-fixas/excluir/${id}`;
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}