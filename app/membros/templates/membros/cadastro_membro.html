{% extends 'base.html' %}

{% block titulo %}
  {% if membro %}Editar Membro{% else %}Novo Membro{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho da página -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-dark mb-1">
                        <i class="fas fa-user-plus text-primary me-2"></i>
                        {% if membro %}Editar Membro{% else %}Novo Membro{% endif %}
                    </h2>
                    <p class="text-muted">
                        {% if membro %}
                            Edite as informações do membro {{ membro.nome }}
                        {% else %}
                            Preencha os dados para cadastrar um novo membro
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('membros.lista_membros') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar à Lista
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulário -->
    <div class="row justify-content-center">
        <div class="col-xl-10">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-edit text-secondary me-2"></i>
                        Informações do Membro
                    </h5>
                </div>
                
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('membros.salvar_membro') }}" novalidate>
                        {% if membro %}
                            <input type="hidden" name="id" value="{{ membro.id }}">
                        {% endif %}
                        
                        <!-- Dados Pessoais -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-user me-2"></i>
                                    Dados Pessoais
                                </h6>
                            </div>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-8">
                                <label for="nome" class="form-label fw-bold">
                                    Nome Completo <span class="text-danger">*</span>
                                </label>
                                <input type="text" 
                                       class="form-control form-control-lg" 
                                       id="nome" 
                                       name="nome" 
                                       value="{{ membro.nome if membro else '' }}" 
                                       required>
                                <div class="form-text">Nome completo do membro</div>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="status" class="form-label fw-bold">Status</label>
                                <select class="form-select form-select-lg" id="status" name="status">
                                    <option value="Ativo" {% if membro and membro.status == 'Ativo' %}selected{% elif not membro %}selected{% endif %}>Ativo</option>
                                    <option value="Inativo" {% if membro and membro.status == 'Inativo' %}selected{% endif %}>Inativo</option>
                                    <option value="Visitante" {% if membro and membro.status == 'Visitante' %}selected{% endif %}>Visitante</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label for="tipo" class="form-label fw-bold">
                                    Tipo <span class="text-danger">*</span>
                                </label>
                                <select class="form-select form-select-lg" id="tipo" name="tipo" onchange="toggleTipoAreas()">
                                    <option value="Membro" {% if membro and membro.tipo == 'Membro' %}selected{% elif not membro %}selected{% endif %}>Membro</option>
                                    <option value="Obreiro" {% if membro and membro.tipo == 'Obreiro' %}selected{% endif %}>Obreiro</option>
                                    <option value="Lider" {% if membro and membro.tipo == 'Lider' %}selected{% endif %}>Líder de Departamento</option>
                                </select>
                                <div class="form-text">Função do membro na igreja</div>
                            </div>
                            
                            <div class="col-md-8">
                                <!-- Área condicional para Obreiros -->
                                <div id="area-obreiro" style="display: none;">
                                    <label class="form-label fw-bold text-info">
                                        <i class="fas fa-user-tie me-1"></i>
                                        Informações de Obreiro
                                    </label>
                                    <div class="alert alert-info mb-0">
                                        <small>Este membro será incluído na lista de obreiros da igreja.</small>
                                    </div>
                                </div>
                                
                                <!-- Área condicional para Líderes -->
                                <div id="area-lider" style="display: none;">
                                    <label class="form-label fw-bold text-warning">
                                        <i class="fas fa-crown me-1"></i>
                                        Informações de Líder
                                    </label>
                                    <div class="alert alert-warning mb-0">
                                        <small>Este membro será incluído na lista de líderes de departamento.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="telefone" class="form-label fw-bold">Telefone</label>
                                <input type="tel" 
                                       class="form-control" 
                                       id="telefone" 
                                       name="telefone" 
                                       value="{{ membro.telefone if membro else '' }}"
                                       placeholder="(11) 99999-9999">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="email" class="form-label fw-bold">E-mail</label>
                                <input type="email" 
                                       class="form-control" 
                                       id="email" 
                                       name="email" 
                                       value="{{ membro.email if membro else '' }}"
                                       placeholder="exemplo@email.com">
                            </div>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="cpf" class="form-label fw-bold">CPF</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="cpf" 
                                       name="cpf" 
                                       value="{{ membro.cpf if membro else '' }}"
                                       placeholder="000.000.000-00"
                                       maxlength="14">
                                <div class="form-text">Cadastro de Pessoa Física</div>
                            </div>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="data_nascimento" class="form-label fw-bold">Data de Nascimento</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="data_nascimento" 
                                       name="data_nascimento" 
                                       value="{{ membro.data_nascimento.strftime('%Y-%m-%d') if membro and membro.data_nascimento else '' }}">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="data_batismo" class="form-label fw-bold">Data de Batismo</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="data_batismo" 
                                       name="data_batismo" 
                                       value="{{ membro.data_batismo.strftime('%Y-%m-%d') if membro and membro.data_batismo else '' }}">
                            </div>
                        </div>

                        <!-- Endereço -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    Endereço
                                </h6>
                            </div>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="endereco" class="form-label fw-bold">Endereço</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="endereco" 
                                       name="endereco" 
                                       value="{{ membro.endereco if membro else '' }}"
                                       placeholder="Rua, Avenida">
                            </div>
                            
                            <div class="col-md-2">
                                <label for="numero" class="form-label fw-bold">Número</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="numero" 
                                       name="numero" 
                                       value="{{ membro.numero if membro else '' }}"
                                       placeholder="Nº">
                            </div>
                            
                            <div class="col-md-4">
                                <label for="cep" class="form-label fw-bold">
                                    CEP 
                                    <span id="cep-loading" class="spinner-border spinner-border-sm text-primary d-none" role="status">
                                        <span class="visually-hidden">Buscando...</span>
                                    </span>
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="cep" 
                                       name="cep" 
                                       value="{{ membro.cep if membro else '' }}"
                                       placeholder="00000-000"
                                       data-toggle="tooltip"
                                       title="Digite o CEP para preenchimento automático">
                                <div id="cep-feedback" class="form-text"></div>
                            </div>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label for="bairro" class="form-label fw-bold">Bairro</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="bairro" 
                                       name="bairro" 
                                       value="{{ membro.bairro if membro else '' }}"
                                       placeholder="Nome do bairro">
                            </div>
                            
                            <div class="col-md-5">
                                <label for="cidade" class="form-label fw-bold">Cidade</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="cidade" 
                                       name="cidade" 
                                       value="{{ membro.cidade if membro else '' }}"
                                       placeholder="Nome da cidade">
                            </div>
                            
                            <div class="col-md-3">
                                <label for="estado" class="form-label fw-bold">Estado</label>
                                <select class="form-select" id="estado" name="estado">
                                    <option value="">Selecione...</option>
                                    <option value="SP" {% if membro and membro.estado == 'SP' %}selected{% endif %}>São Paulo</option>
                                    <option value="RJ" {% if membro and membro.estado == 'RJ' %}selected{% endif %}>Rio de Janeiro</option>
                                    <option value="MG" {% if membro and membro.estado == 'MG' %}selected{% endif %}>Minas Gerais</option>
                                    <option value="RS" {% if membro and membro.estado == 'RS' %}selected{% endif %}>Rio Grande do Sul</option>
                                    <option value="PR" {% if membro and membro.estado == 'PR' %}selected{% endif %}>Paraná</option>
                                    <option value="SC" {% if membro and membro.estado == 'SC' %}selected{% endif %}>Santa Catarina</option>
                                    <option value="BA" {% if membro and membro.estado == 'BA' %}selected{% endif %}>Bahia</option>
                                    <option value="GO" {% if membro and membro.estado == 'GO' %}selected{% endif %}>Goiás</option>
                                    <option value="ES" {% if membro and membro.estado == 'ES' %}selected{% endif %}>Espírito Santo</option>
                                    <option value="MT" {% if membro and membro.estado == 'MT' %}selected{% endif %}>Mato Grosso</option>
                                    <option value="MS" {% if membro and membro.estado == 'MS' %}selected{% endif %}>Mato Grosso do Sul</option>
                                    <option value="DF" {% if membro and membro.estado == 'DF' %}selected{% endif %}>Distrito Federal</option>
                                </select>
                            </div>
                        </div>

                        <!-- Observações -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-sticky-note me-2"></i>
                                    Observações Adicionais
                                </h6>
                            </div>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <label for="observacoes" class="form-label fw-bold">Observações</label>
                                <textarea class="form-control" 
                                          id="observacoes" 
                                          name="observacoes" 
                                          rows="4" 
                                          placeholder="Informações adicionais sobre o membro...">{{ membro.observacoes if membro else '' }}</textarea>
                                <div class="form-text">Informações complementares, ministérios, talentos, etc.</div>
                            </div>
                        </div>

                        <!-- Botões de Ação -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{{ url_for('membros.lista_membros') }}" class="btn btn-secondary btn-lg">
                                        <i class="fas fa-times me-2"></i>
                                        Cancelar
                                    </a>
                                    
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-save me-2"></i>
                                        {% if membro %}Atualizar Membro{% else %}Cadastrar Membro{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    border-radius: 15px;
    overflow: hidden;
}

.form-control, .form-select {
    border-radius: 8px;
    border: 1px solid #e0e6ed;
    transition: all 0.2s ease;
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary-green);
    box-shadow: 0 0 0 0.2rem rgba(34, 139, 34, 0.15);
}

.form-control-lg {
    padding: 1rem;
    font-size: 1.1rem;
}

.text-primary {
    color: var(--primary-green) !important;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-green), var(--primary-blue));
    border: none;
    border-radius: 8px;
    padding: 0.75rem 2rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(34, 139, 34, 0.3);
}

.btn-secondary {
    border-radius: 8px;
    padding: 0.75rem 2rem;
    font-weight: 600;
}

.required-asterisk {
    color: #dc3545;
}

h6.text-primary {
    font-weight: 600;
    margin-bottom: 1rem;
}

/* Estilos para busca de CEP */
.campo-preenchido {
    animation: highlightField 1.5s ease-in-out;
    background-color: rgba(40, 167, 69, 0.1) !important;
}

@keyframes highlightField {
    0% { 
        background-color: rgba(40, 167, 69, 0.3);
        transform: scale(1.02);
    }
    50% { 
        background-color: rgba(40, 167, 69, 0.2);
    }
    100% { 
        background-color: rgba(40, 167, 69, 0.1);
        transform: scale(1);
    }
}

.form-control.is-valid {
    border-color: #198754;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='m2.3 6.73.94-.94 1.96 1.96L8.78 4.28l-.94-.94L4.22 6.96l-.94-.94L2.3 6.73z'/%3e%3c/svg%3e");
}

.form-control.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 4.6 2.4 2.4M8.2 4.6l-2.4 2.4'/%3e%3c/svg%3e");
}

#cep-loading {
    margin-left: 8px;
}

.form-text.text-success {
    color: #198754 !important;
    font-weight: 500;
}

.form-text.text-danger {
    color: #dc3545 !important;
    font-weight: 500;
}

.form-text.text-info {
    color: #0dcaf0 !important;
    font-weight: 500;
}
</style>

<script>
// Função para mostrar/ocultar áreas baseado no tipo
function toggleTipoAreas() {
    const tipoSelect = document.getElementById('tipo');
    const areaObreiro = document.getElementById('area-obreiro');
    const areaLider = document.getElementById('area-lider');
    
    // Esconder todas as áreas primeiro
    areaObreiro.style.display = 'none';
    areaLider.style.display = 'none';
    
    // Mostrar área apropriada baseado na seleção
    if (tipoSelect.value === 'Obreiro') {
        areaObreiro.style.display = 'block';
    } else if (tipoSelect.value === 'Lider') {
        areaLider.style.display = 'block';
    }
}

// Máscara para telefone
document.getElementById('telefone').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    value = value.replace(/(\d{2})(\d)/, '($1) $2');
    value = value.replace(/(\d{5})(\d)/, '$1-$2');
    e.target.value = value;
});

// Máscara e busca automática para CEP
document.getElementById('cep').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    value = value.replace(/(\d{5})(\d)/, '$1-$2');
    e.target.value = value;
    
    // Se o CEP tem 8 dígitos, busca automaticamente
    if (value.replace(/\D/g, '').length === 8) {
        buscarCEP(value);
    } else {
        limparFeedbackCEP();
    }
});

// Função para buscar CEP na API ViaCEP
async function buscarCEP(cep) {
    const cepLimpo = cep.replace(/\D/g, '');
    const loadingElement = document.getElementById('cep-loading');
    const feedbackElement = document.getElementById('cep-feedback');
    const cepInput = document.getElementById('cep');
    
    // Mostra loading
    loadingElement.classList.remove('d-none');
    feedbackElement.textContent = 'Buscando endereço...';
    feedbackElement.className = 'form-text text-info';
    cepInput.classList.remove('is-invalid', 'is-valid');
    
    try {
        const response = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
        const data = await response.json();
        
        if (data.erro) {
            throw new Error('CEP não encontrado');
        }
        
        // Preenche os campos automaticamente
        if (data.logradouro) {
            document.getElementById('endereco').value = data.logradouro;
        }
        
        if (data.bairro) {
            document.getElementById('bairro').value = data.bairro;
        }
        
        if (data.localidade) {
            document.getElementById('cidade').value = data.localidade;
        }
        
        if (data.uf) {
            document.getElementById('estado').value = data.uf;
        }
        
        // Feedback de sucesso
        feedbackElement.textContent = `✓ Endereço encontrado: ${data.localidade}/${data.uf}`;
        feedbackElement.className = 'form-text text-success';
        cepInput.classList.add('is-valid');
        
        // Efeito visual nos campos preenchidos
        animarCampoPreenchido('endereco');
        animarCampoPreenchido('bairro');
        animarCampoPreenchido('cidade');
        animarCampoPreenchido('estado');
        
    } catch (error) {
        // Feedback de erro
        feedbackElement.textContent = '⚠ CEP não encontrado. Verifique o número digitado.';
        feedbackElement.className = 'form-text text-danger';
        cepInput.classList.add('is-invalid');
    } finally {
        // Esconde loading
        loadingElement.classList.add('d-none');
    }
}

// Função para animar campo preenchido
function animarCampoPreenchido(fieldId) {
    const field = document.getElementById(fieldId);
    if (field && field.value) {
        field.classList.add('campo-preenchido');
        setTimeout(() => {
            field.classList.remove('campo-preenchido');
        }, 1500);
    }
}

// Função para limpar feedback do CEP
function limparFeedbackCEP() {
    const feedbackElement = document.getElementById('cep-feedback');
    const cepInput = document.getElementById('cep');
    
    feedbackElement.textContent = '';
    cepInput.classList.remove('is-invalid', 'is-valid');
}

// Validação do formulário
document.querySelector('form').addEventListener('submit', function(e) {
    const nome = document.getElementById('nome').value.trim();
    
    if (!nome) {
        e.preventDefault();
        alert('Por favor, preencha o nome do membro.');
        document.getElementById('nome').focus();
    }
});

// Inicialização dos tooltips
document.addEventListener('DOMContentLoaded', function() {
    // Inicializa tooltips do Bootstrap se disponível
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
    
    // Máscara para CPF
    const cpfInput = document.getElementById('cpf');
    if (cpfInput) {
        cpfInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, ''); // Remove tudo que não é dígito
            
            // Aplica a máscara
            if (value.length <= 11) {
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            }
            
            e.target.value = value;
        });
    }
});
</script>
{% endblock %}