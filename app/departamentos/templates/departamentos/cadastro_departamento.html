{% extends 'base.html' %}

{% block titulo %}
  {% if departamento %}Editar Departamento{% else %}Novo Departamento{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho da página -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-dark mb-1">
                        <i class="fas fa-church text-primary me-2"></i>
                        {% if departamento %}Editar Departamento{% else %}Novo Departamento{% endif %}
                    </h2>
                    <p class="text-muted">
                        {% if departamento %}
                            Edite as informações do departamento {{ departamento.nome }}
                        {% else %}
                            Preencha os dados para cadastrar um novo departamento
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('departamentos.lista_departamentos') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar à Lista
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulário -->
    <div class="row justify-content-center">
        <div class="col-xl-10">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-edit text-secondary me-2"></i>
                        Informações do Departamento
                    </h5>
                </div>
                
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('departamentos.salvar_departamento') }}">
                        {% if departamento %}
                            <input type="hidden" name="id" value="{{ departamento.id }}">
                        {% endif %}
                        
                        <!-- Dados Básicos -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Dados Básicos
                                </h6>
                            </div>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-8">
                                <label for="nome" class="form-label fw-bold">
                                    Nome do Departamento <span class="text-danger">*</span>
                                </label>
                                <input type="text" 
                                       class="form-control form-control-lg" 
                                       id="nome" 
                                       name="nome" 
                                       value="{{ departamento.nome if departamento else '' }}" 
                                       required>
                                <div class="form-text">Nome completo do departamento ou ministério</div>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="status" class="form-label fw-bold">Status</label>
                                <select class="form-select form-select-lg" id="status" name="status">
                                    <option value="Ativo" {% if departamento and departamento.status == 'Ativo' %}selected{% elif not departamento %}selected{% endif %}>Ativo</option>
                                    <option value="Inativo" {% if departamento and departamento.status == 'Inativo' %}selected{% endif %}>Inativo</option>
                                    <option value="Em Formação" {% if departamento and departamento.status == 'Em Formação' %}selected{% endif %}>Em Formação</option>
                                    <option value="Suspenso" {% if departamento and departamento.status == 'Suspenso' %}selected{% endif %}>Suspenso</option>
                                </select>
                            </div>
                        </div>

                        <!-- Liderança -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-crown me-2"></i>
                                    Liderança
                                </h6>
                            </div>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="lider" class="form-label fw-bold">
                                    <i class="fas fa-user-crown text-warning me-1"></i>
                                    Líder Principal
                                </label>
                                <select class="form-select" id="lider" name="lider">
                                    <option value="">Selecione o líder...</option>
                                    {% for lider_obj in lideres %}
                                    <option value="{{ lider_obj.nome }}" 
                                            {% if departamento and departamento.lider == lider_obj.nome %}selected{% endif %}>
                                        {{ lider_obj.nome }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Responsável principal pelo departamento</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="vice_lider" class="form-label fw-bold">
                                    <i class="fas fa-user-check text-info me-1"></i>
                                    Vice-Líder
                                </label>
                                <select class="form-select" id="vice_lider" name="vice_lider">
                                    <option value="">Selecione o vice-líder...</option>
                                    {% for membro in membros %}
                                    <option value="{{ membro.nome }}" 
                                            {% if departamento and departamento.vice_lider == membro.nome %}selected{% endif %}>
                                        {{ membro.nome }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Segundo responsável do departamento</div>
                            </div>
                        </div>

                        <!-- Contato -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-phone me-2"></i>
                                    Informações de Contato
                                </h6>
                            </div>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-12">
                                <label for="contato" class="form-label fw-bold">Contato</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="contato" 
                                       name="contato" 
                                       value="{{ departamento.contato if departamento else '' }}"
                                       placeholder="Telefone, WhatsApp ou e-mail do departamento">
                                <div class="form-text">Telefone, WhatsApp ou e-mail para contato com o departamento</div>
                            </div>
                        </div>

                        <!-- Descrição -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-align-left me-2"></i>
                                    Descrição e Objetivos
                                </h6>
                            </div>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <label for="descricao" class="form-label fw-bold">Descrição</label>
                                <textarea class="form-control" 
                                          id="descricao" 
                                          name="descricao" 
                                          rows="5" 
                                          placeholder="Descreva os objetivos, atividades e propósito do departamento...">{{ departamento.descricao if departamento else '' }}</textarea>
                                <div class="form-text">Objetivos, atividades principais, propósito, horários de reunião, etc.</div>
                            </div>
                        </div>

                        <!-- Cronograma de Atividades Detalhado -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-calendar-alt me-2"></i>
                                    Cronograma de Atividades
                                </h6>
                            </div>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <label class="form-label fw-bold mb-0">Atividades Programadas</label>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="adicionarCronograma()">
                                        <i class="fas fa-plus me-1"></i>Adicionar Atividade
                                    </button>
                                </div>
                                
                                <div id="cronogramas-container" class="border rounded p-3 bg-light">
                                    <!-- Cronogramas existentes serão carregados aqui -->
                                    <div class="text-muted text-center" id="cronogramas-vazio">
                                        <i class="fas fa-calendar-plus fa-2x mb-2"></i>
                                        <p>Nenhuma atividade programada ainda.<br>Clique em "Adicionar Atividade" para começar.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sistema de Aulas Detalhado -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-graduation-cap me-2"></i>
                                    Sistema de Ensino
                                </h6>
                            </div>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="possui_aulas" 
                                           name="possui_aulas"
                                           {% if departamento and departamento.possui_aulas %}checked{% endif %}
                                           onchange="toggleSistemaAulas()">
                                    <label class="form-check-label fw-bold" for="possui_aulas">
                                        <i class="fas fa-chalkboard-teacher me-2"></i>
                                        Este departamento oferece aulas/cursos
                                    </label>
                                </div>
                                
                                <div id="aulas-section" style="display: {% if departamento and departamento.possui_aulas %}block{% else %}none{% endif %};">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <label class="form-label fw-bold mb-0">Aulas Oferecidas</label>
                                        <button type="button" class="btn btn-sm btn-outline-success" onclick="adicionarAula()">
                                            <i class="fas fa-plus me-1"></i>Adicionar Aula
                                        </button>
                                    </div>
                                    
                                    <div id="aulas-container" class="border rounded p-3 bg-light">
                                        <!-- Aulas existentes serão carregadas aqui -->
                                        <div class="text-muted text-center" id="aulas-vazio">
                                            <i class="fas fa-book-open fa-2x mb-2"></i>
                                            <p>Nenhuma aula cadastrada ainda.<br>Clique em "Adicionar Aula" para começar.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Compatibilidade com campos antigos (ocultos) -->
                        <input type="hidden" id="cronograma_mensal" name="cronograma_mensal" value="{{ departamento.cronograma_mensal if departamento else '' }}">
                        <input type="hidden" id="planejamento_aulas" name="planejamento_aulas" value="{{ departamento.planejamento_aulas if departamento else '' }}">

                        <!-- Botões de Ação -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{{ url_for('departamentos.lista_departamentos') }}" class="btn btn-secondary btn-lg">
                                        <i class="fas fa-times me-2"></i>
                                        Cancelar
                                    </a>
                                    
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-save me-2"></i>
                                        {% if departamento %}Atualizar Departamento{% else %}Cadastrar Departamento{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    border-radius: 15px;
    overflow: hidden;
}

.form-control, .form-select {
    border-radius: 8px;
    border: 1px solid #e0e6ed;
    transition: all 0.2s ease;
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary-green);
    box-shadow: 0 0 0 0.2rem rgba(34, 139, 34, 0.15);
}

.form-control-lg {
    padding: 1rem;
    font-size: 1.1rem;
}

.text-primary {
    color: var(--primary-green) !important;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-green), var(--primary-blue));
    border: none;
    border-radius: 8px;
    padding: 0.75rem 2rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(34, 139, 34, 0.3);
}

.btn-secondary {
    border-radius: 8px;
    padding: 0.75rem 2rem;
    font-weight: 600;
}

h6.text-primary {
    font-weight: 600;
    margin-bottom: 1rem;
}

.required-asterisk {
    color: #dc3545;
}

.fa-user-crown {
    color: #ffc107;
}

.fa-user-check {
    color: #17a2b8;
}

/* Estilo para sugestões de departamentos comuns */
.department-suggestions {
    margin-top: 0.5rem;
}

.department-suggestions .badge {
    margin: 0.2rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.department-suggestions .badge:hover {
    transform: scale(1.05);
}

/* Animações para o campo de planejamento */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

#planejamento-container {
    transition: all 0.3s ease;
}

/* Estilo para campos de aulas */
.form-check-input:checked {
    background-color: #0b1b3a;
    border-color: #0b1b3a;
}

.form-check-input:focus {
    border-color: #0b1b3a;
    box-shadow: 0 0 0 0.25rem rgba(11, 27, 58, 0.25);
}

/* Estilos para cronogramas e aulas dinâmicos */
.cronograma-item, .aula-item {
    transition: all 0.3s ease;
    position: relative;
}

.cronograma-item:hover, .aula-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}

.cronograma-item h6, .aula-item h6 {
    font-size: 0.9rem;
}

#cronogramas-container, #aulas-container {
    min-height: 120px;
    max-height: 500px;
    overflow-y: auto;
}

#cronogramas-vazio, #aulas-vazio {
    transition: all 0.3s ease;
}

/* Animação para novos itens */
.cronograma-item[data-temp="true"], .aula-item[data-temp="true"] {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Cores específicas para cronogramas e aulas */
.cronograma-item {
    border-left: 4px solid #0b1b3a;
}

.aula-item {
    border-left: 4px solid #28a745;
}

/* Preview de arquivo */
.arquivo-preview {
    animation: fadeIn 0.3s ease;
}

.arquivo-preview .alert {
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.arquivo-preview .arquivo-nome {
    flex: 1;
    margin-right: 10px;
    word-break: break-all;
}

.arquivo-preview .btn-close {
    padding: 0.5rem;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-5px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
// Máscara para contato (telefone ou email)
document.getElementById('contato').addEventListener('input', function(e) {
    let value = e.target.value;
    
    // Se parece com telefone (apenas números), aplica máscara
    if (/^\d+$/.test(value.replace(/\D/g, ''))) {
        value = value.replace(/\D/g, '');
        if (value.length <= 11) {
            value = value.replace(/(\d{2})(\d)/, '($1) $2');
            value = value.replace(/(\d{5})(\d)/, '$1-$2');
        }
        e.target.value = value;
    }
});

// ============================================================================
// SALVAR CRONOGRAMAS E AULAS ANTES DE SUBMETER O FORMULÁRIO
// ============================================================================

document.querySelector('form').addEventListener('submit', async function(e) {
    // Se estivermos editando um departamento existente
    const departamentoId = document.querySelector('input[name="id"]')?.value;
    
    if (departamentoId) {
        // Capturar todos os cronogramas novos (data-temp="true")
        const novosCronogramas = document.querySelectorAll('.cronograma-item[data-temp="true"]');
        
        if (novosCronogramas.length > 0) {
            e.preventDefault(); // Impedir submit temporariamente
            
            let todosOk = true;
            
            // Salvar cada cronograma via AJAX
            for (let item of novosCronogramas) {
                const cronogramaData = {
                    titulo: item.querySelector('.cronograma-titulo').value,
                    data_evento: item.querySelector('.cronograma-data').value,
                    horario: item.querySelector('.cronograma-horario').value,
                    local: item.querySelector('.cronograma-local').value,
                    responsavel: item.querySelector('.cronograma-responsavel').value,
                    descricao: item.querySelector('.cronograma-descricao').value,
                    exibir_no_painel: item.querySelector('.cronograma-painel').checked
                };
                
                try {
                    const response = await fetch(`/departamentos/${departamentoId}/cronogramas/adicionar`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(cronogramaData)
                    });
                    
                    if (!response.ok) {
                        todosOk = false;
                        console.error('Erro ao salvar cronograma:', await response.text());
                    } else {
                        // Remover atributo data-temp para não tentar salvar novamente
                        item.removeAttribute('data-temp');
                    }
                } catch (error) {
                    todosOk = false;
                    console.error('Erro ao salvar cronograma:', error);
                }
            }
            
            // Capturar todas as aulas novas
            const novasAulas = document.querySelectorAll('.aula-item[data-temp="true"]');
            
            // Salvar cada aula via AJAX
            for (let item of novasAulas) {
                // Usar FormData para enviar arquivo junto
                const formData = new FormData();
                formData.append('titulo', item.querySelector('.aula-titulo').value);
                formData.append('descricao', item.querySelector('.aula-descricao').value);
                formData.append('professora', item.querySelector('.aula-professora').value);
                formData.append('dia_semana', item.querySelector('.aula-dia-semana').value);
                formData.append('horario', item.querySelector('.aula-horario').value);
                formData.append('local', item.querySelector('.aula-local').value);
                formData.append('data_inicio', item.querySelector('.aula-data-inicio').value);
                formData.append('data_fim', item.querySelector('.aula-data-fim').value);
                formData.append('max_alunos', item.querySelector('.aula-max-alunos').value);
                formData.append('material_necessario', item.querySelector('.aula-material').value);
                formData.append('exibir_no_painel', item.querySelector('.aula-painel').checked);
                
                // Adicionar arquivo se selecionado
                const arquivoInput = item.querySelector('.aula-arquivo');
                if (arquivoInput.files && arquivoInput.files[0]) {
                    formData.append('arquivo', arquivoInput.files[0]);
                }
                
                try {
                    const response = await fetch(`/departamentos/${departamentoId}/aulas/adicionar`, {
                        method: 'POST',
                        body: formData  // Não definir Content-Type, o navegador faz automaticamente
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok || result.erro) {
                        todosOk = false;
                        console.error('Erro ao salvar aula:', result.erro || await response.text());
                        alert(`Erro ao salvar aula: ${result.erro || 'Erro desconhecido'}`);
                    } else {
                        console.log('Aula salva com sucesso:', result);
                        item.removeAttribute('data-temp');
                    }
                } catch (error) {
                    todosOk = false;
                    console.error('Erro ao salvar aula:', error);
                    alert(`Erro ao salvar aula: ${error.message}`);
                }
            }
            
            // Agora submeter o formulário principal
            if (todosOk) {
                // Reenviar o formulário sem preventDefault
                e.target.submit();
            } else {
                alert('Alguns cronogramas ou aulas não puderam ser salvos. Verifique o console.');
            }
        }
    }
});

// Sugestões de departamentos comuns
document.addEventListener('DOMContentLoaded', function() {
    const nomeInput = document.getElementById('nome');
    const sugestoes = [
        'Louvor e Adoração', 'Escola Bíblica Dominical', 'Ministério Infantil', 
        'Ministério de Jovens', 'Ministério de Casais', 'Ministério de Mulheres',
        'Ministério de Homens', 'Evangelismo', 'Discipulado', 'Células',
        'Patrimônio', 'Comunicação', 'Recepção', 'Intercessão'
    ];
    
    // Adicionar sugestões abaixo do campo nome
    if (!document.querySelector('.department-suggestions')) {
        const suggestionsDiv = document.createElement('div');
        suggestionsDiv.className = 'department-suggestions';
        suggestionsDiv.innerHTML = '<small class="text-muted">Sugestões: </small>';
        
        sugestoes.forEach(sugestao => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-light text-dark border';
            badge.textContent = sugestao;
            badge.onclick = () => {
                nomeInput.value = sugestao;
                nomeInput.focus();
            };
            suggestionsDiv.appendChild(badge);
        });
        
        nomeInput.parentNode.appendChild(suggestionsDiv);
    }
});

// ============================================================================
// FUNÇÕES PARA GERENCIAR CRONOGRAMAS
// ============================================================================

function adicionarCronograma() {
    const container = document.getElementById('cronogramas-container');
    const vazioDiv = document.getElementById('cronogramas-vazio');
    
    const cronogramaHtml = `
        <div class="cronograma-item border rounded p-3 mb-3 bg-white" data-temp="true">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="text-primary mb-0">
                    <i class="fas fa-calendar-day me-2"></i>Nova Atividade
                </h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerCronograma(this)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label">Data</label>
                    <input type="date" class="form-control form-control-sm cronograma-data" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Horário</label>
                    <input type="time" class="form-control form-control-sm cronograma-horario">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Título *</label>
                    <input type="text" class="form-control form-control-sm cronograma-titulo" placeholder="Ex: Reunião de Planejamento" required>
                </div>
            </div>
            
            <div class="row g-2 mt-2">
                <div class="col-md-6">
                    <label class="form-label">Local</label>
                    <input type="text" class="form-control form-control-sm cronograma-local" placeholder="Ex: Sala de reuniões">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Responsável</label>
                    <input type="text" class="form-control form-control-sm cronograma-responsavel" placeholder="Ex: João Silva">
                </div>
            </div>
            
            <div class="row g-2 mt-2">
                <div class="col-md-8">
                    <label class="form-label">Descrição</label>
                    <textarea class="form-control form-control-sm cronograma-descricao" rows="2" placeholder="Descreva a atividade..."></textarea>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <div class="form-check form-switch">
                        <input class="form-check-input cronograma-painel" type="checkbox" checked>
                        <label class="form-check-label">
                            <i class="fas fa-eye me-1"></i>Exibir no Painel
                        </label>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (vazioDiv) {
        vazioDiv.style.display = 'none';
    }
    
    container.insertAdjacentHTML('beforeend', cronogramaHtml);
}

function removerCronograma(button) {
    const cronogramaItem = button.closest('.cronograma-item');
    const container = document.getElementById('cronogramas-container');
    
    cronogramaItem.remove();
    
    // Se não há mais cronogramas, mostrar mensagem vazia
    const cronogramas = container.querySelectorAll('.cronograma-item');
    if (cronogramas.length === 0) {
        document.getElementById('cronogramas-vazio').style.display = 'block';
    }
}

// ============================================================================
// FUNÇÕES PARA GERENCIAR AULAS
// ============================================================================

function adicionarAula() {
    const container = document.getElementById('aulas-container');
    const vazioDiv = document.getElementById('aulas-vazio');
    
    const aulaHtml = `
        <div class="aula-item border rounded p-3 mb-3 bg-white" data-temp="true">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="text-success mb-0">
                    <i class="fas fa-graduation-cap me-2"></i>Nova Aula/Curso
                </h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerAula(this)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="row g-2">
                <div class="col-md-6">
                    <label class="form-label">Título da Aula *</label>
                    <input type="text" class="form-control form-control-sm aula-titulo" placeholder="Ex: Curso de Discipulado" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Professora/Instrutor</label>
                    <input type="text" class="form-control form-control-sm aula-professora" placeholder="Ex: Maria Santos">
                </div>
            </div>
            
            <div class="row g-2 mt-2">
                <div class="col-md-3">
                    <label class="form-label">Dia da Semana</label>
                    <select class="form-select form-select-sm aula-dia-semana">
                        <option value="">Selecione...</option>
                        <option value="Segunda-feira">Segunda-feira</option>
                        <option value="Terça-feira">Terça-feira</option>
                        <option value="Quarta-feira">Quarta-feira</option>
                        <option value="Quinta-feira">Quinta-feira</option>
                        <option value="Sexta-feira">Sexta-feira</option>
                        <option value="Sábado">Sábado</option>
                        <option value="Domingo">Domingo</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Horário</label>
                    <input type="time" class="form-control form-control-sm aula-horario">
                    <small class="text-muted">Hora de início</small>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Local</label>
                    <input type="text" class="form-control form-control-sm aula-local" placeholder="Ex: Sala de aulas">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Máx. Alunos</label>
                    <input type="number" class="form-control form-control-sm aula-max-alunos" placeholder="Ex: 20">
                </div>
            </div>
            
            <div class="row g-2 mt-2">
                <div class="col-md-3">
                    <label class="form-label">Data Início</label>
                    <input type="date" class="form-control form-control-sm aula-data-inicio">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Data Fim</label>
                    <input type="date" class="form-control form-control-sm aula-data-fim">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Material Necessário</label>
                    <input type="text" class="form-control form-control-sm aula-material" placeholder="Ex: Bíblia, caderno">
                </div>
            </div>
            
            <div class="row g-2 mt-2">
                <div class="col-md-6">
                    <label class="form-label">Descrição</label>
                    <textarea class="form-control form-control-sm aula-descricao" rows="2" placeholder="Descreva o conteúdo e objetivos da aula..."></textarea>
                </div>
                <div class="col-md-4">
                    <label class="form-label">
                        <i class="fas fa-paperclip me-1"></i>Anexar Arquivo
                    </label>
                    <input type="file" class="form-control form-control-sm aula-arquivo" 
                           accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.bmp,.webp" 
                           title="Anexe materiais didáticos, apostilas, imagens, etc."
                           onchange="mostrarArquivoSelecionado(this)">
                    <small class="text-muted">PDF, DOC, TXT, JPG, JPEG, PNG (máx. 5MB)</small>
                    
                    <!-- Preview do arquivo selecionado -->
                    <div class="arquivo-preview mt-2" style="display:none;">
                        <div class="alert alert-info alert-dismissible fade show p-2 mb-0" role="alert">
                            <i class="fas fa-file me-1"></i>
                            <span class="arquivo-nome"></span>
                            <button type="button" class="btn-close btn-close-sm" onclick="removerArquivo(this)" aria-label="Remover"></button>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <div class="form-check form-switch">
                        <input class="form-check-input aula-painel" type="checkbox">
                        <label class="form-check-label">
                            <i class="fas fa-chalkboard me-1"></i>Exibir no Painel
                        </label>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (vazioDiv) {
        vazioDiv.style.display = 'none';
    }
    
    container.insertAdjacentHTML('beforeend', aulaHtml);
}

function removerAula(button) {
    const aulaItem = button.closest('.aula-item');
    const container = document.getElementById('aulas-container');
    
    aulaItem.remove();
    
    // Se não há mais aulas, mostrar mensagem vazia
    const aulas = container.querySelectorAll('.aula-item');
    if (aulas.length === 0) {
        document.getElementById('aulas-vazio').style.display = 'block';
    }
}

// ============================================================================
// FUNÇÕES PARA EXCLUIR CRONOGRAMAS E AULAS SALVOS
// ============================================================================

function removerCronogramaSalvo(cronogramaId, button) {
    if (!confirm('Deseja realmente excluir esta atividade?')) {
        return;
    }
    
    fetch(`/cronogramas/${cronogramaId}/excluir`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.sucesso) {
            // Remover o elemento da tela
            const cronogramaItem = button.closest('.cronograma-item');
            const container = document.getElementById('cronogramas-container');
            
            cronogramaItem.remove();
            
            // Se não há mais cronogramas, mostrar mensagem vazia
            const cronogramas = container.querySelectorAll('.cronograma-item');
            if (cronogramas.length === 0) {
                document.getElementById('cronogramas-vazio').style.display = 'block';
            }
            
            // Mostrar mensagem de sucesso
            alert('Atividade excluída com sucesso!');
        } else {
            alert('Erro ao excluir atividade: ' + (data.erro || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro ao excluir cronograma:', error);
        alert('Erro ao excluir atividade. Verifique o console para mais detalhes.');
    });
}

function removerAulaSalva(aulaId, button) {
    if (!confirm('Deseja realmente excluir esta aula?')) {
        return;
    }
    
    fetch(`/aulas/${aulaId}/excluir`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.sucesso) {
            // Remover o elemento da tela
            const aulaItem = button.closest('.aula-item');
            const container = document.getElementById('aulas-container');
            
            aulaItem.remove();
            
            // Se não há mais aulas, mostrar mensagem vazia
            const aulas = container.querySelectorAll('.aula-item');
            if (aulas.length === 0) {
                document.getElementById('aulas-vazio').style.display = 'block';
            }
            
            // Mostrar mensagem de sucesso
            alert('Aula excluída com sucesso!');
        } else {
            alert('Erro ao excluir aula: ' + (data.erro || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro ao excluir aula:', error);
        alert('Erro ao excluir aula. Verifique o console para mais detalhes.');
    });
}

// ============================================================================
// FUNÇÕES DE CARREGAMENTO (PARA EDIÇÃO)
// ============================================================================

function carregarCronogramasExistentes(departamentoId) {
    fetch(`/departamentos/${departamentoId}/cronogramas/listar`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('cronogramas-container');
            const vazioDiv = document.getElementById('cronogramas-vazio');
            
            if (data.cronogramas && data.cronogramas.length > 0) {
                vazioDiv.style.display = 'none';
                
                data.cronogramas.forEach(cronograma => {
                    const cronogramaHtml = `
                        <div class="cronograma-item border rounded p-3 mb-3 bg-white" data-id="${cronograma.id}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="text-primary mb-0">
                                    <i class="fas fa-calendar-check me-2"></i>${cronograma.titulo}
                                    ${cronograma.exibir_no_painel ? '<span class="badge bg-success ms-2"><i class="fas fa-eye me-1"></i>No Painel</span>' : '<span class="badge bg-secondary ms-2"><i class="fas fa-eye-slash me-1"></i>Privado</span>'}
                                </h6>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerCronogramaSalvo(${cronograma.id}, this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="row g-2">
                                <div class="col-md-3"><strong>Data:</strong> ${cronograma.data_evento}</div>
                                <div class="col-md-3"><strong>Horário:</strong> ${cronograma.horario || '-'}</div>
                                <div class="col-md-6"><strong>Local:</strong> ${cronograma.local || '-'}</div>
                            </div>
                            ${cronograma.descricao ? `<div class="mt-2"><strong>Descrição:</strong> ${cronograma.descricao}</div>` : ''}
                            ${cronograma.responsavel ? `<div class="mt-1"><strong>Responsável:</strong> ${cronograma.responsavel}</div>` : ''}
                        </div>
                    `;
                    container.insertAdjacentHTML('afterbegin', cronogramaHtml);
                });
            }
        })
        .catch(error => console.error('Erro ao carregar cronogramas:', error));
}

function carregarAulasExistentes(departamentoId) {
    fetch(`/departamentos/${departamentoId}/aulas/listar`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('aulas-container');
            const vazioDiv = document.getElementById('aulas-vazio');
            
            if (data.aulas && data.aulas.length > 0) {
                vazioDiv.style.display = 'none';
                
                data.aulas.forEach(aula => {
                    const aulaHtml = `
                        <div class="aula-item border rounded p-3 mb-3 bg-white" data-id="${aula.id}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="text-success mb-0">
                                    <i class="fas fa-graduation-cap me-2"></i>${aula.titulo}
                                </h6>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerAulaSalva(${aula.id}, this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="row g-2">
                                <div class="col-md-4"><strong>Professor(a):</strong> ${aula.professora || '-'}</div>
                                <div class="col-md-4"><strong>Dia:</strong> ${aula.dia_semana || '-'}</div>
                                <div class="col-md-4"><strong>Horário:</strong> ${aula.horario || '-'}</div>
                            </div>
                            ${aula.descricao ? `<div class="mt-2"><strong>Descrição:</strong> ${aula.descricao}</div>` : ''}
                        </div>
                    `;
                    container.insertAdjacentHTML('afterbegin', aulaHtml);
                });
            }
        })
        .catch(error => console.error('Erro ao carregar aulas:', error));
}

// ============================================================================
// FUNÇÕES DE GERENCIAMENTO DE ARQUIVOS
// ============================================================================

function mostrarArquivoSelecionado(input) {
    const aulaDiv = input.closest('.aula-item');
    const preview = aulaDiv.querySelector('.arquivo-preview');
    const nomeSpan = preview.querySelector('.arquivo-nome');
    
    if (input.files && input.files[0]) {
        const arquivo = input.files[0];
        const tamanhoMB = (arquivo.size / (1024 * 1024)).toFixed(2);
        
        // Verificar tamanho
        if (arquivo.size > 5 * 1024 * 1024) {
            alert('Arquivo muito grande! Tamanho máximo: 5MB');
            input.value = '';
            preview.style.display = 'none';
            return;
        }
        
        // Mostrar nome e tamanho do arquivo
        nomeSpan.textContent = `${arquivo.name} (${tamanhoMB} MB)`;
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
}

function removerArquivo(button) {
    const aulaDiv = button.closest('.aula-item');
    const inputArquivo = aulaDiv.querySelector('.aula-arquivo');
    const preview = aulaDiv.querySelector('.arquivo-preview');
    
    // Limpar input file
    inputArquivo.value = '';
    
    // Esconder preview
    preview.style.display = 'none';
}

// Função para mostrar/ocultar seção de aulas
function toggleSistemaAulas() {
    const checkbox = document.getElementById('possui_aulas');
    const section = document.getElementById('aulas-section');
    
    if (checkbox.checked) {
        section.style.display = 'block';
        section.style.animation = 'fadeIn 0.3s ease-in';
    } else {
        section.style.display = 'none';
        // Limpar aulas ao desmarcar
        document.getElementById('aulas-container').innerHTML = `
            <div class="text-muted text-center" id="aulas-vazio">
                <i class="fas fa-book-open fa-2x mb-2"></i>
                <p>Nenhuma aula cadastrada ainda.<br>Clique em "Adicionar Aula" para começar.</p>
            </div>
        `;
    }
}

// Verificar estado inicial ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    toggleSistemaAulas();
    
    // Carregar cronogramas e aulas existentes se estivermos editando
    const departamentoId = document.querySelector('input[name="id"]')?.value;
    if (departamentoId) {
        carregarCronogramasExistentes(departamentoId);
        carregarAulasExistentes(departamentoId);
    }
    
    // Configurar auto-preenchimento de contato ao selecionar líder
    configurarAutoPreenchimentoContato();
});

// Auto-preencher contato quando selecionar líder
function configurarAutoPreenchimentoContato() {
    // Criar objeto com dados dos líderes
    const lideresData = {
        {% for lider_obj in lideres %}
        "{{ lider_obj.nome }}": {
            telefone: "{{ lider_obj.telefone or '' }}",
            email: "{{ lider_obj.email or '' }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };
    
    // Criar objeto com dados de todos os membros (para vice-líder)
    const membrosData = {
        {% for membro in membros %}
        "{{ membro.nome }}": {
            telefone: "{{ membro.telefone or '' }}",
            email: "{{ membro.email or '' }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };
    
    // Ao selecionar líder principal
    document.getElementById('lider').addEventListener('change', function() {
        const liderNome = this.value;
        const campoContato = document.getElementById('contato');
        
        if (liderNome && lideresData[liderNome]) {
            const dados = lideresData[liderNome];
            let contato = '';
            
            if (dados.telefone) {
                contato = dados.telefone;
            }
            if (dados.email) {
                contato += (contato ? ' / ' : '') + dados.email;
            }
            
            if (contato) {
                campoContato.value = contato;
            }
        }
    });
    
    // Ao selecionar vice-líder (opcional, caso queira adicionar contato secundário)
    document.getElementById('vice_lider').addEventListener('change', function() {
        const viceLiderNome = this.value;
        
        if (viceLiderNome && membrosData[viceLiderNome]) {
            // Aqui você pode optar por adicionar o contato do vice ao campo
            // ou criar um campo específico para contato do vice-líder
        }
    });
}
</script>
{% endblock %}